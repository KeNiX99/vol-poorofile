// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © kenix9961821
//@version=5
indicator('KeNiX‘s VPCOMBO ', shorttitle='KNXVPC', overlay=true, max_lines_count=495, max_boxes_count=99, max_bars_back=1998,max_labels_count = 495)

block_size = input.int(9, 'Bars in profile block', minval=3, maxval=999)
visual_row_width = input.int(9, 'Visual row width', minval=3)
show_peaks = input(true, 'Show peaks')
use_custom_volume_source = input(false, 'Use custom volume source')
volume_source_symbol = input.symbol('', 'Custom volume source symbol')

BOUNDS_COLOR = color.gray
PROFILE_COLOR = color.new(color.gray, 9)
PEAK_COLOR = color.new(color.orange,  9)
alert_data_msg = ""
alert_real =""
custom_volume = use_custom_volume_source ? request.security(volume_source_symbol, timeframe.period, volume, lookahead=barmerge.lookahead_on) : volume


i_size = 45 //input.int(25, 'parts', minval=5, maxval=50)
i_width = 1 //input(15, 'max width')
aMax = 99 //input.int(500, 'max lines', maxval=500)
c_volH = input(color.new(color.yellow, 81), title='color vol max')
c_vol = input(color.new(color.blue, 81), title='color vol')
c_POC = input(color.new(color.yellow, 9), title='color POC')

maxVol = ta.highest(volume, aMax)


chT_H = ta.change(time('1D'))
chT_Lo = ta.change(time('60'))

var t_H = 0
var t_L = 0
t_H := 1000 * 60 * 60 * 24 //periodH == '1' ? 1000 * 60 : periodH == '3' ? 1000 * 60 * 3 : periodH == '5' ? 1000 * 60 * 5 : periodH == '10' ? 1000 * 60 * 10 : periodH == '15' ? 1000 * 60 * 15 : periodH == '30' ? 1000 * 60 * 30 : periodH == '60' ? 1000 * 60 * 60 : periodH == '120' ? 1000 * 60 * 60 * 2 : periodH == '180' ? 1000 * 60 * 60 * 3 : periodH == '240' ? 1000 * 60 * 60 * 4 : periodH == '360' ? 1000 * 60 * 60 * 6 : periodH == '720' ? 1000 * 60 * 60 * 12 : periodH == '1D' ? 1000 * 60 * 60 * 24 : periodH == '3D' ? 1000 * 60 * 60 * 24 * 3 : periodH == '1W' ? 1000 * 60 * 60 * 24 * 7 : periodH == '1M' ? 1000 * 60 * 60 * 24 * 30 : 1000 * 60 * 60 * 24 * 365

t_L := 1000 * 60 * 60 //not i_auto ? periodL == '1' ? 1000 * 60 : periodL == '3' ? 1000 * 60 * 3 : periodL == '5' ? 1000 * 60 * 5 : periodL == '10' ? 1000 * 60 * 10 : periodL == '15' ? 1000 * 60 * 15 : periodL == '30' ? 1000 * 60 * 30 : periodL == '60' ? 1000 * 60 * 60 : periodL == '120' ? 1000 * 60 * 60 * 2 : periodL == '180' ? 1000 * 60 * 60 * 3 : periodL == '240' ? 1000 * 60 * 60 * 4 : periodL == '360' ? 1000 * 60 * 60 * 6 : periodL == '720' ? 1000 * 60 * 60 * 12 : periodL == '1D' ? 1000 * 60 * 60 * 24 : periodL == '3D' ? 1000 * 60 * 60 * 24 * 3 : periodL == '1W' ? 1000 * 60 * 60 * 24 * 7 : 1000 * 60 * 60 * 24 * 30 : timeframe.isseconds ? 1000 * timeframe.multiplier : timeframe.isminutes ? 1000 * 60 * timeframe.multiplier : periodL == '60' ? 1000 * 60 * 60 : periodL == '120' ? 1000 * 60 * 60 * 2 : periodL == '180' ? 1000 * 60 * 60 * 3 : periodL == '240' ? 1000 * 60 * 60 * 4 : periodL == '360' ? 1000 * 60 * 60 * 6 : periodL == '720' ? 1000 * 60 * 60 * 12 : timeframe.isdaily ? 1000 * 60 * 60 * 24 * timeframe.multiplier : timeframe.isweekly ? 1000 * 60 * 60 * 24 * 7 * timeframe.multiplier : 1000 * 60 * 60 * 24 * 30 * timeframe.multiplier

mult = t_H / t_L
//-----------------fibo
// ══════════════════════════════════════════════════════════════════════════════════════════════════ //
//
// Fibonacci Retracement / Extention / Pivot Points and Zig Zag
// ══════════════════════════════════════════════════════════════════════════════════════════════════ //

// ---------------------------------------------------------------------------------------------- //
// -Inputs -------------------------------------------------------------------------------------- //

tooltip_threshold   = 'Deviation is a multiplier that affects how much the price should deviate from the previous pivot in order for the bar to become a new pivot' + 
                      '\n\nDepth affects the minimum number of bars that will be taken into account when building'

tooltip_pivot_point = 'A pivot point is a technical analysis indicator used to determine the overall trend of the market over different time frames'

tooltip_zigzag      = 'The Zig Zag indicator is used to identify price trends then connected by straight lines that help the trader visual the price action' + 
                      'This indicator works to eliminate confusion over small price changes or fluctuations and aims to project trend changes overtime'
// ---------------------------------------------------------------------------------------------- //


group_pick   = 'Pick a Fibonacci Tool'

i_isFib      = input.bool  (true, 'Pick a Fibonacci Tool', inline='FIB', group=group_pick)
i_fibTool    = input.string('Pivot Points', '             ', 
                             options=['Pivot Points', 'Retracements', 'Retracements + Pivot Points', 'Extentions', 'Extentions + Pivot Points'], inline='FIB', group=group_pick)

i_fibTime    = input.bool (true, 'Fib Time Zones', inline='TZ', group=group_pick)
i_tzColor    = input.color(#2196f3, ''           , inline='TZ', group=group_pick)
// ---------------------------------------------------------------------------------------------- //

group_pivot  = 'Fibonacci Pivot Points Settings'

i_htf_mode   = input.string('Auto', 'Pivot Points TimeFrame', options=['Auto', 'User Defined'], inline='HTF', group=group_pivot, tooltip=tooltip_pivot_point)
i_htf_user_  = input.string('Weekly', '          or User Defined', 
                             options=['15 Min', '1 Hour', '4 Hour', 'Daily', 'Weekly', 'Monthly', 'Quarterly', 'Yearly'], inline='HTF1', group=group_pivot)

i_htf_user   = i_htf_user_ == '15 Min'    ? '15'  : 
               i_htf_user_ == '1 Hour'    ? '60'  : 
               i_htf_user_ == '4 Hour'    ? '240' : 
               i_htf_user_ == 'Daily'     ? 'D'   : 
               i_htf_user_ == 'Weekly'    ? 'W'   : 
               i_htf_user_ == 'Monthly'   ? 'M'   : 
               i_htf_user_ == 'Quarterly' ? '3M'  : '12M'

i_levelsPvt  = input.string('Levels', 'Level Labels', options=['Levels', 'Prices', 'Levels + Prices', 'None'], inline='pvt', group=group_pivot)
i_levelsPvtP = input.string('Pivot End', '', options=['Last Bar', 'Pivot End'], inline='pvt', group=group_pivot)
i_levelsPvtS = input.string('Small', '', options=['Small', 'Normal'], inline='pvt', group=group_pivot)

i_relevant   = input.bool(false, 'Only Relevant Pivot Point Levels', group=group_pivot)
i_histPP     = input.bool(false, 'Historical Pivot Points', group=group_pivot)
i_extend     = input.bool(false, 'Extend Pivot Point Lines', inline='fLines', group=group_pivot)
i_extendL    = input.string('Dashed', '', options=['Dashed', 'Dotted', 'Solid'], inline='fLines', group=group_pivot)

// ---------------------------------------------------------------------------------------------- //

group_fib_tool = 'Fibonacci Extention / Retracement / TimeZone Settings'

i_dev_thresh = ta.atr(10) / close * 100 * input.float(3, 'Deviation', minval=0, inline='Pivots', group=group_fib_tool, tooltip=tooltip_threshold)
i_depth      = input.int(11, '       Depth', minval=1, inline='Pivots', group=group_fib_tool)

i_levels     = input.string('Levels', 'Level Labels', options=['Levels', 'Prices', 'Levels + Prices', 'None'], inline='fLines', group=group_fib_tool)
i_levelsP    = input.string('Pivot Start', '', options=['Last Bar', 'Pivot Start'], inline='fLines', group=group_fib_tool)
i_levelsS    = input.string('Small', '', options=['Small', 'Normal'], inline='fLines', group=group_fib_tool)

i_reverse    = input.bool(false, 'Reverse Extention / Retracement Levels', group=group_fib_tool)
i_extendER   = input.bool(false, 'Extend Extention / Retracement Lines', inline='fLine', group=group_fib_tool)
i_histPivot  = input.int (0, 'Historical Extention / Retracement Levels', minval=0, group=group_fib_tool)

i_histPivot2 = input.int(0, 'Historical Time Zones', minval=0, group=group_fib_tool)
i_fib_tzl    = input.bool(true, 'Time Zone Lables', inline='tz poz', group=group_fib_tool)
i_fib_tzlp   = input.string('Left', '', options=['Right', 'Left'], inline='tz poz', group=group_fib_tool)
fib_tzlp     = i_fib_tzlp == 'Left' ? label.style_label_left : label.style_label_right
i_fib_tzlp2  = input.string('Bottom', '', options=['Bottom', 'Top'], inline='tz poz', group=group_fib_tool)


// ---------------------------------------------------------------------------------------------- //

group_zigzag = 'ZigZag Settings'

i_zigZag     = input.bool(false, 'Zig Zag  ', inline='ZZ', group=group_zigzag, tooltip=tooltip_zigzag)
i_zzColor    = input.color(#c77a08, '', inline='ZZ', group=group_zigzag)
i_zzStyle    = input.string('Solid', '', options=['Dashed', 'Dotted', 'Solid'], inline='ZZ', group=group_zigzag)
i_zzWidth    = input.int(1, '', minval=1, inline='ZZ', group=group_zigzag)


// ---------------------------------------------------------------------------------------------- //
// -Calculations -------------------------------------------------------------------------------- //

var line lineLast = na
var int iLast = 0
var int iPrev = 0
var float pLast = 0
var isHighLast = false  // otherwise the last pivot is a low pivot

var iPrevPivot = 0
var pPrevPivot = 0.
var iLastPivot = 0
var pLastPivot = 0.

pivots(src, length, isHigh) =>
    l2 = length * 2
    c = nz(src[length])
    ok = true

    for i = 0 to l2 by 1
        if isHigh and src[i] > c
            ok := false
            ok

        if not isHigh and src[i] < c
            ok := false
            ok
    if ok
        [bar_index[length], c]
    else
        [int(na), float(na)]

[iH, pH] = pivots(high, i_depth / 2, true)
[iL, pL] = pivots(low, i_depth / 2, false)

calc_dev(base_price, price) =>
    100 * (price - base_price) / price

pivotFound(dev, isHigh, index, price) =>
    if isHighLast == isHigh and not na(lineLast)
        // same direction
        if isHighLast ? price > pLast : price < pLast
            line.set_xy2(lineLast, index, price)
            [lineLast, isHighLast]
        else
            [line(na), bool(na)]
    else
        // reverse the direction (or create the very first line)
        if math.abs(dev) > i_dev_thresh
            // price move is significant

            // ---------------------------------------------------------------------------------------- //
            [zzCol, zzWid, zzSty] = if not i_zigZag
                [na, 1, line.style_dashed]
            else
                [i_zzColor, i_zzWidth, i_zzStyle == 'Solid' ? line.style_solid : i_zzStyle == 'Dotted' ? line.style_dotted : line.style_dashed]
            // ---------------------------------------------------------------------------------------- //

            id = line.new(iLast, pLast, index, price, color=zzCol, width=zzWid, style=zzSty)
            [id, isHigh]
        else
            [line(na), bool(na)]

if not na(iH)
    dev = calc_dev(pLast, pH)
    [id, isHigh] = pivotFound(dev, true, iH, pH)

    if not na(id)
        if id != lineLast
            // ---------------------------------------------------------------------------------------- //
            iPrevPivot := line.get_x1(lineLast)
            pPrevPivot := line.get_y1(lineLast)
            iLastPivot := line.get_x2(lineLast)
            pLastPivot := line.get_y2(lineLast)

            if not i_zigZag
            // ---------------------------------------------------------------------------------------- //

                line.delete(lineLast)

        lineLast := id
        isHighLast := isHigh
        iPrev := iLast
        iLast := iH
        pLast := pH
        pLast
else
    if not na(iL)
        dev = calc_dev(pLast, pL)
        [id, isHigh] = pivotFound(dev, false, iL, pL)

        if not na(id)
            if id != lineLast
                // ---------------------------------------------------------------------------------------- //
                iPrevPivot := line.get_x1(lineLast)
                pPrevPivot := line.get_y1(lineLast)
                iLastPivot := line.get_x2(lineLast)
                pLastPivot := line.get_y2(lineLast)

                if not i_zigZag
                // ---------------------------------------------------------------------------------------- //

                    line.delete(lineLast)

            lineLast := id
            isHighLast := isHigh
            iPrev := iLast
            iLast := iL
            pLast := pL
            pLast

iStartBase = i_histPivot  > 0 ? ta.valuewhen(ta.change(iPrevPivot), iPrevPivot, i_histPivot)      : ta.valuewhen(ta.change(iPrevPivot), iPrevPivot, 0)
pStartBase = i_histPivot  > 0 ? ta.valuewhen(ta.change(pPrevPivot), pPrevPivot, i_histPivot)      : ta.valuewhen(ta.change(pPrevPivot), pPrevPivot, 0)
iEndBase   = i_histPivot  > 0 ? ta.valuewhen(ta.change(iLastPivot), iLastPivot, i_histPivot  - 1) : line.get_x2(lineLast)
pEndBase   = i_histPivot  > 0 ? ta.valuewhen(ta.change(pLastPivot), pLastPivot, i_histPivot  - 1) : line.get_y2(lineLast)
iMidPivot  = i_histPivot  > 0 ? ta.valuewhen(ta.change(iPrevPivot), iPrevPivot, i_histPivot  - 1) : line.get_x1(lineLast)
pMidPivot  = i_histPivot  > 0 ? ta.valuewhen(ta.change(pPrevPivot), pPrevPivot, i_histPivot  - 1) : line.get_y1(lineLast)

iEndBase2  = i_histPivot2 > 0 ? ta.valuewhen(ta.change(iLastPivot), iLastPivot, i_histPivot2 - 1) : line.get_x2(lineLast)
pEndBase2  = i_histPivot2 > 0 ? ta.valuewhen(ta.change(pLastPivot), pLastPivot, i_histPivot2 - 1) : line.get_y2(lineLast)
iMidPivot2 = i_histPivot2 > 0 ? ta.valuewhen(ta.change(iPrevPivot), iPrevPivot, i_histPivot2 - 1) : line.get_x1(lineLast)
pMidPivot2 = i_histPivot2 > 0 ? ta.valuewhen(ta.change(pPrevPivot), pPrevPivot, i_histPivot2 - 1) : line.get_y1(lineLast)

//------------------------------------------------------------------------------
// auto higher time frame code snippet from pine wizard LonesomeTheBlue 

htf_auto = timeframe.period == '1'   ? '240' : 
           timeframe.period == '3'   ? '240' : 
           timeframe.period == '5'   ? '240' : 
           timeframe.period == '15'  ? 'D'   : 
           timeframe.period == '30'  ? 'D'   : 
           timeframe.period == '45'  ? 'D'   : 
           timeframe.period == '60'  ? 'W'   : 
           timeframe.period == '120' ? 'W'   : 
           timeframe.period == '180' ? 'W'   : 
           timeframe.period == '240' ? 'W'   : 
           timeframe.period == 'D'   ? 'M'   : 
           timeframe.period == 'W'   ? '3M'  : '12M'

//htf = i_htf_mode == 'Auto' ? htf_auto : i_htf_user
htf = 'D'
//------------------------------------------------------------------------------
// security function free price calculations

f_htf_ohlc(_htf) =>
    var htf_o  = 0.
    var htf_h  = 0.
    var htf_l  = 0.
    htf_c      = close
    
    var htf_ox = 0.
    var htf_hx = 0.
    var htf_lx = 0.
    var htf_cx = 0.

    if ta.change(time(_htf))
        htf_ox := htf_o
        htf_o  := open
        
        htf_hx := htf_h
        htf_h  := high
        
        htf_lx := htf_l
        htf_l  := low
        
        htf_cx := htf_c[1]
        htf_cx
    else
        htf_h := math.max(high, htf_h)
        htf_l := math.min(low , htf_l)
        htf_l

    [htf_ox, htf_hx, htf_lx, htf_cx, htf_o, htf_h, htf_l, htf_c]

[_, htf_h1, htf_l1, htf_c1, _, _, _, _] = f_htf_ohlc(htf)

// ---------------------------------------------------------------------------------------------- //
// -Plotting ------------------------------------------------------------------------------------ //

time_x10 = ta.valuewhen(ta.change(time(htf)), time, 1)
time_x11 = ta.valuewhen(ta.change(time(htf)), time, 0)
time_x21 = 2 * time_x11 - time_x10

f_drawLineX(_x1, _y1, _x2, _y2, _xloc, _extend, _color, _style, _width) =>
    var id = line.new(_x1, _y1, _x2, _y2, _xloc, _extend, _color, _style, _width)

    if _y1 > 0 and _y2 > 0
        line.set_xy1(id, _x1, _y1)
        line.set_xy2(id, _x2, _y2)
        line.set_color(id, _color)
    else
        line.set_xy1(id, _x1, close)
        line.set_xy2(id, _x2, close)
        line.set_color(id, #00000000)

f_drawLabelX(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip) =>
    var id = label.new(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip)
    label.set_text(id, i_extend or i_extendER or i_levelsP == 'Last Bar' ? _text + '\n\n' : _text)
    label.set_tooltip(id, _tooltip)

    if _y > 0
        label.set_xy(id, _x, _y)
        label.set_textcolor(id, _textcolor)
    else
        label.set_xy(id, _x, close)
        label.set_textcolor(id, #00000000)

f_crossingLevel(_curret, _level) =>
    _level > _curret and _level < _curret[1] or _level < _curret and _level > _curret[1]

var ln = array.new_line()
var lb = array.new_label()

if ta.change(time) and array.size(ln) > 0
    for i = 1 to array.size(ln) by 1
        line.delete(array.shift(ln))

if ta.change(time) and array.size(lb) > 0
    for i = 1 to array.size(lb) by 1
        label.delete(array.shift(lb))

f_drawLineTZ(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w) =>
    if _x1 - bar_index < 500
        array.push(ln, line.new(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w))

f_drawLabelTZ(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip) =>
    if _x - bar_index < 500
        array.push(lb, label.new(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip))

f_drawLinePVT(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w) =>
    if _y1 > 0
        array.push(ln, line.new(_x1, _y1, _x2, _y2, _xloc, _extend, _c, _s, _w))

f_drawLabelPVT(_x, _y, _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip) =>
    if _y > 0
        array.push(lb, label.new(_x, _y, i_extend or i_levelsPvtP == "Last Bar" ? _text + '\n\n' : _text, _xloc, _yloc, _color, _style, _textcolor, _size, _textalign, _tooltip))

if i_fibTime
    referance = math.round(iEndBase2 - iMidPivot2)

    f_drawLineTZ(iMidPivot2 - referance       , pEndBase2, iMidPivot2 - referance     , pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2                   , pEndBase2, iMidPivot2                 , pMidPivot2, xloc.bar_index, extend.both, color.gray, line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance       , pEndBase2, iMidPivot2 + referance     , pMidPivot2, xloc.bar_index, extend.both, color.gray, line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 2   , pEndBase2, iMidPivot2 + referance * 2 , pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 3   , pEndBase2, iMidPivot2 + referance * 3 , pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 5   , pEndBase2, iMidPivot2 + referance * 5 , pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 8   , pEndBase2, iMidPivot2 + referance * 8 , pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 13  , pEndBase2, iMidPivot2 + referance * 13, pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 21  , pEndBase2, iMidPivot2 + referance * 21, pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 34  , pEndBase2, iMidPivot2 + referance * 34, pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 55  , pEndBase2, iMidPivot2 + referance * 55, pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)
    f_drawLineTZ(iMidPivot2 + referance * 89  , pEndBase2, iMidPivot2 + referance * 89, pMidPivot2, xloc.bar_index, extend.both, i_tzColor , line.style_solid, 1)

    if i_fib_tzl
        f_drawLabelTZ(iMidPivot2 + referance * -1, i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '-1', xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 0 , i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '0' , xloc.bar_index, yloc.price, #00000000, fib_tzlp, color.gray, size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 1 , i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '1' , xloc.bar_index, yloc.price, #00000000, fib_tzlp, color.gray, size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 2 , i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '2' , xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 3 , i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '3' , xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 5 , i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '5' , xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 8 , i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '8' , xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 13, i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '13', xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 21, i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '21', xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 34, i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '34', xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 55, i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '55', xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')
        f_drawLabelTZ(iMidPivot2 + referance * 89, i_fib_tzlp2 == 'Bottom' ? math.min(pEndBase2, pMidPivot2) : math.max(pEndBase2, pMidPivot2), '89', xloc.bar_index, yloc.price, #00000000, fib_tzlp, i_tzColor , size.normal, text.align_center, '')

f_processLevelX(_show, _level, _color, _pp) =>
    //_pp = math.avg(htf_h1, htf_l1, htf_c1)
    if i_isFib
        pPivotDiff = math.abs(pMidPivot - pEndBase)
        price = 0.
        
        if i_fibTool == 'Extentions' or i_fibTool == 'Extentions + Pivot Points'
            f_drawLineX(iStartBase, pStartBase, iMidPivot, pMidPivot, xloc.bar_index, extend.none, color.gray, line.style_dashed, 1)
            f_drawLineX(iMidPivot , pMidPivot , iEndBase , pEndBase , xloc.bar_index, extend.none, color.gray, line.style_dashed, 1)

            offset = math.abs(pMidPivot - pStartBase)
            price := pEndBase < pMidPivot ? pMidPivot - pPivotDiff + (i_reverse ? -1 : 1) * offset * _level : pMidPivot + pPivotDiff - (i_reverse ? -1 : 1) * offset * _level

            if _show
                f_drawLineX(iMidPivot, price, bar_index, price, xloc.bar_index, i_extendER ? extend.both : extend.right, _color, line.style_solid, 1)

                if i_levels != 'None'
                    bar = i_levelsP == "Last Bar" ? bar_index : iMidPivot
                    style = i_levelsP == "Last Bar" ? label.style_label_left : label.style_label_right
                    size = i_levelsS == 'Small' ? size.small : size.normal
                    f_drawLabelX(bar, price, (i_levels == 'Prices' ? '' : 'EXT ' + str.tostring(_level)) + (i_levels == 'Levels + Prices' or i_levels == 'Prices' ? ' (' + str.tostring(price, format.mintick) + ')' : ''), xloc.bar_index, yloc.price, #00000000, style, _color, size, text.align_left, str.tostring(price, format.mintick))

                //if f_crossingLevel(close, price)
                    //alert('AutoFib Extention : ' + syminfo.ticker + ' crossing level ' + str.tostring(_level))

        if i_fibTool == 'Retracements' or i_fibTool == 'Retracements + Pivot Points'
            f_drawLineX(iMidPivot, pMidPivot, iEndBase, pEndBase, xloc.bar_index, extend.none, color.gray, line.style_dashed, 1)

            price := pEndBase < pMidPivot ? (i_reverse ? pEndBase : pMidPivot) - (i_reverse ? -1 : 1) * pPivotDiff * _level : (i_reverse ? pEndBase : pMidPivot) + (i_reverse ? -1 : 1) * pPivotDiff * _level

            if _show
                f_drawLineX(iMidPivot, price, bar_index, price, xloc.bar_index, i_extendER ? extend.both : extend.right, _color, line.style_solid, 1)

                if i_levels != 'None'
                    bar = i_levelsP == "Last Bar" ? bar_index : iMidPivot
                    style = i_levelsP == "Last Bar" ? label.style_label_left : label.style_label_right
                    size = i_levelsS == 'Small' ? size.small : size.normal
                    f_drawLabelX(bar, price, (i_levels == 'Prices' ? '' : 'RET ' + str.tostring(_level)) + (i_levels == 'Levels + Prices' or i_levels == 'Prices' ? ' (' + str.tostring(price, format.mintick) + ')' : ''), xloc.bar_index, yloc.price, #00000000, style, _color, size, text.align_left, str.tostring(price, format.mintick))

                //if f_crossingLevel(close, price)
                    //alert('AutoFib Retracment : ' + syminfo.ticker + ' crossing level ' + str.tostring(_level))

        if i_fibTool == 'Pivot Points' or i_fibTool == 'Extentions + Pivot Points' or i_fibTool == 'Retracements + Pivot Points'
            pivot = math.avg(htf_h1, htf_l1, htf_c1)
            range_2 = htf_h1 - htf_l1
            if not i_histPP
                f_drawLinePVT(time_x10, pivot, time_x21, pivot, xloc.bar_time, extend.none, color.gray, line.style_dashed, 1)

            if _show and _level >= 0
                pvtPoints = _level == 0 or _level == 0.382 or _level == 0.618 or _level == 1

                f_drawLinePVT(time_x11, pivot - range_2 * _level, time_x21, pivot - range_2 * _level, xloc.bar_time, extend.none, i_relevant ? close < pivot ? _color : na : _color, pvtPoints ? line.style_solid : line.style_dashed, pvtPoints ? 2 : 1)
                f_drawLinePVT(time_x11, pivot + range_2 * _level, time_x21, pivot + range_2 * _level, xloc.bar_time, extend.none, i_relevant ? close > pivot ? _color : na : _color, pvtPoints ? line.style_solid : line.style_dashed, pvtPoints ? 2 : 1)

                if i_extend
                    style = i_extendL == 'Solid' ? line.style_solid : i_extendL == 'Dotted' ? line.style_dotted : line.style_dashed
                    f_drawLinePVT(time_x11, pivot - range_2 * _level, time_x21, pivot - range_2 * _level, xloc.bar_time, extend.both, i_relevant ? close < pivot ? _color : na : _color, style, 1)
                    f_drawLinePVT(time_x11, pivot + range_2 * _level, time_x21, pivot + range_2 * _level, xloc.bar_time, extend.both, i_relevant ? close > pivot ? _color : na : _color, style, 1)

                if i_levelsPvt != 'None'
                    time_xx = i_levelsPvtP == "Last Bar" ? timenow : time_x21
                    size = i_levelsPvtS == 'Small' ? size.small : size.normal
                    if pvtPoints
                        if _level == 0
                            f_drawLabelPVT(time_xx, pivot, (i_levelsPvt == 'Prices' ? '' : 'PP') + (i_levelsPvt == 'Levels + Prices' or i_levelsPvt == 'Prices' ? ' (' + str.tostring(pivot, format.mintick) + ')' : ''), xloc.bar_time, yloc.price, #00000000, label.style_label_left, _color, size, text.align_left, str.tostring(pivot, format.mintick))
                           
                        else
                            f_drawLabelPVT(time_xx, pivot - range_2 * _level, (i_levelsPvt == 'Prices' ? '' : (_level == 0.382 ? 'S1 PP ' : _level == 0.618 ? 'S2 PP ' : 'S3 PP ') + str.tostring(_level)) + (i_levelsPvt == 'Levels + Prices' or i_levelsPvt == 'Prices' ? ' (' + str.tostring(pivot - range_2 * _level, format.mintick) + ')' : ''), xloc.bar_time, yloc.price, #00000000, label.style_label_left, i_relevant ? close < pivot ? _color : na : _color, size, text.align_left, str.tostring(pivot - range_2 * _level, format.mintick))
                            f_drawLabelPVT(time_xx, pivot + range_2 * _level, (i_levelsPvt == 'Prices' ? '' : (_level == 0.382 ? 'R1 PP ' : _level == 0.618 ? 'R2 PP ' : 'R3 PP ') + str.tostring(_level)) + (i_levelsPvt == 'Levels + Prices' or i_levelsPvt == 'Prices' ? ' (' + str.tostring(pivot + range_2 * _level, format.mintick) + ')' : ''), xloc.bar_time, yloc.price, #00000000, label.style_label_left, i_relevant ? close > pivot ? _color : na : _color, size, text.align_left, str.tostring(pivot + range_2 * _level, format.mintick))
                    else
                        f_drawLabelPVT(time_xx, pivot - range_2 * _level, (i_levelsPvt == 'Prices' ? '' : '   PP ' + str.tostring(_level)) + (i_levelsPvt == 'Levels + Prices' or i_levelsPvt == 'Prices' ? ' (' + str.tostring(pivot - range_2 * _level, format.mintick) + ')' : ''), xloc.bar_time, yloc.price, #00000000, label.style_label_left, i_relevant ? close < pivot ? _color : na : _color, size, text.align_left, str.tostring(pivot - range_2 * _level, format.mintick))
                        f_drawLabelPVT(time_xx, pivot + range_2 * _level, (i_levelsPvt == 'Prices' ? '' : '   PP ' + str.tostring(_level)) + (i_levelsPvt == 'Levels + Prices' or i_levelsPvt == 'Prices' ? ' (' + str.tostring(pivot + range_2 * _level, format.mintick) + ')' : ''), xloc.bar_time, yloc.price, #00000000, label.style_label_left, i_relevant ? close > pivot ? _color : na : _color, size, text.align_left, str.tostring(pivot + range_2 * _level, format.mintick))

                //if f_crossingLevel(close, pivot - range_2 * _level)
                    //alert('AutoFib PivotPoints : ' + syminfo.ticker + ' crossing support level ' + str.tostring(_level))

                //if f_crossingLevel(close, pivot + range_2 * _level)
                    //alert('AutoFib PivotPoints : ' + syminfo.ticker + ' crossing resistance level ' + str.tostring(_level))



group_fib_levels = 'Fibonacci Levels'
float pp =0.0
show_0  = input.bool(true, '', inline='Level0', group=group_fib_levels)
value_0 = input.float(0., '', inline='Level0', group=group_fib_levels)
color_0 = input.color(#787b86, '', inline='Level0', group=group_fib_levels)
f_processLevelX(show_0, value_0, color_0, pp)

show_0_236  = input.bool(true, '', inline='Level0', group=group_fib_levels)
value_0_236 = input.float(0.236, '', inline='Level0', group=group_fib_levels)
color_0_236 = input.color(#f44336, '', inline='Level0', group=group_fib_levels)
f_processLevelX(show_0_236, value_0_236, color_0_236,pp)

show_0_382  = input.bool(true, '', inline='Level1', group=group_fib_levels)
value_0_382 = input.float(0.382, '', inline='Level1', group=group_fib_levels)
color_0_382 = input.color(#81c784, '', inline='Level1', group=group_fib_levels)
f_processLevelX(show_0_382, value_0_382, color_0_382,pp)

show_0_5  = input.bool(true, '', inline='Level1', group=group_fib_levels)
value_0_5 = input.float(0.5, '', inline='Level1', group=group_fib_levels)
color_0_5 = input.color(#4caf50, '', inline='Level1', group=group_fib_levels)
f_processLevelX(show_0_5, value_0_5, color_0_5, pp)

show_0_618  = input.bool(true, '', inline='Level2', group=group_fib_levels)
value_0_618 = input.float(0.618, '', inline='Level2', group=group_fib_levels)
color_0_618 = input.color(#009688, '', inline='Level2', group=group_fib_levels)
f_processLevelX(show_0_618, value_0_618, color_0_618, pp)

show_0_65  = input.bool(false, '', inline='Level2', group=group_fib_levels)
value_0_65 = input.float(0.65, '', inline='Level2', group=group_fib_levels)
color_0_65 = input.color(#009688, '', inline='Level2', group=group_fib_levels)
f_processLevelX(show_0_65, value_0_65, color_0_65,pp)

show_0_786  = input.bool(true, '', inline='Level3', group=group_fib_levels)
value_0_786 = input.float(0.786, '', inline='Level3', group=group_fib_levels)
color_0_786 = input.color(#64b5f6, '', inline='Level3', group=group_fib_levels)
f_processLevelX(show_0_786, value_0_786, color_0_786,pp)

show_1  = input.bool(true, '', inline='Level3', group=group_fib_levels)
value_1 = input.float(1., '', inline='Level3', group=group_fib_levels)
color_1 = input.color(#787b86, '', inline='Level3', group=group_fib_levels)
f_processLevelX(show_1, value_1, color_1, pp)

show_1_272  = input.bool(false, '', inline='Level4', group=group_fib_levels)
value_1_272 = input.float(1.272, '', inline='Level4', group=group_fib_levels)
color_1_272 = input.color(#81c784, '', inline='Level4', group=group_fib_levels)
f_processLevelX(show_1_272, value_1_272, color_1_272,pp)

show_1_414  = input.bool(false, '', inline='Level4', group=group_fib_levels)
value_1_414 = input.float(1.414, '', inline='Level4', group=group_fib_levels)
color_1_414 = input.color(#f44336, '', inline='Level4', group=group_fib_levels)
f_processLevelX(show_1_414, value_1_414, color_1_414,pp)

show_1_618  = input.bool(true, '', inline='Level5', group=group_fib_levels)
value_1_618 = input.float(1.618, '', inline='Level5', group=group_fib_levels)
color_1_618 = input.color(#2196f3, '', inline='Level5', group=group_fib_levels)
f_processLevelX(show_1_618, value_1_618, color_1_618,pp)

show_1_65  = input.bool(false, '', inline='Level5', group=group_fib_levels)
value_1_65 = input.float(1.65, '', inline='Level5', group=group_fib_levels)
color_1_65 = input.color(#2196f3, '', inline='Level5', group=group_fib_levels)
f_processLevelX(show_1_65, value_1_65, color_1_65,pp)

show_2_618  = input.bool(false, '', inline='Level6', group=group_fib_levels)
value_2_618 = input.float(2.618, '', inline='Level6', group=group_fib_levels)
color_2_618 = input.color(#f44336, '', inline='Level6', group=group_fib_levels)
f_processLevelX(show_2_618, value_2_618, color_2_618, pp)

show_2_65  = input.bool(false, '', inline='Level6', group=group_fib_levels)
value_2_65 = input.float(2.65, '', inline='Level6', group=group_fib_levels)
color_2_65 = input.color(#f44336, '', inline='Level6', group=group_fib_levels)
f_processLevelX(show_2_65, value_2_65, color_2_65, pp)

show_3_618  = input.bool(false, '', inline='Level7', group=group_fib_levels)
value_3_618 = input.float(3.618, '', inline='Level7', group=group_fib_levels)
color_3_618 = input.color(#9c27b0, '', inline='Level7', group=group_fib_levels)
f_processLevelX(show_3_618, value_3_618, color_3_618, pp)

show_3_65  = input.bool(false, '', inline='Level7', group=group_fib_levels)
value_3_65 = input.float(3.65, '', inline='Level7', group=group_fib_levels)
color_3_65 = input.color(#9c27b0, '', inline='Level7', group=group_fib_levels)
f_processLevelX(show_3_65, value_3_65, color_3_65, pp)

show_4_236  = input.bool(false, '', inline='Level8', group=group_fib_levels)
value_4_236 = input.float(4.236, '', inline='Level8', group=group_fib_levels)
color_4_236 = input.color(#e91e63, '', inline='Level8', group=group_fib_levels)
f_processLevelX(show_4_236, value_4_236, color_4_236, pp)

show_4_618  = input.bool(false, '', inline='Level8', group=group_fib_levels)
value_4_618 = input.float(4.618, '', inline='Level8', group=group_fib_levels)
color_4_618 = input.color(#81c784, '', inline='Level8', group=group_fib_levels)
f_processLevelX(show_4_618, value_4_618, color_4_618, pp)

show_neg_0_236  = input.bool(false, '', inline='Level9', group=group_fib_levels)
value_neg_0_236 = input.float(-0.236, '', inline='Level9', group=group_fib_levels)
color_neg_0_236 = input.color(#f44336, '', inline='Level9', group=group_fib_levels)
f_processLevelX(show_neg_0_236, value_neg_0_236, color_neg_0_236, pp)

show_neg_0_382  = input.bool(false, '', inline='Level9', group=group_fib_levels)
value_neg_0_382 = input.float(-0.382, '', inline='Level9', group=group_fib_levels)
color_neg_0_382 = input.color(#81c784, '', inline='Level9', group=group_fib_levels)
f_processLevelX(show_neg_0_382, value_neg_0_382, color_neg_0_382, pp)

show_neg_0_618  = input.bool(true, '', inline='Level10', group=group_fib_levels)
value_neg_0_618 = input.float(-0.618, '', inline='Level10', group=group_fib_levels)
color_neg_0_618 = input.color(#009688, '', inline='Level10', group=group_fib_levels)
f_processLevelX(show_neg_0_618, value_neg_0_618, color_neg_0_618, pp)

show_neg_0_65  = input.bool(false, '', inline='Level10', group=group_fib_levels)
value_neg_0_65 = input.float(-0.65, '', inline='Level10', group=group_fib_levels)
color_neg_0_65 = input.color(#009688, '', inline='Level10', group=group_fib_levels)
f_processLevelX(show_neg_0_65, value_neg_0_65, color_neg_0_65, pp)

i_histPP := i_histPP and (i_fibTool == 'Pivot Points' or i_fibTool == 'Extentions + Pivot Points' or i_fibTool == 'Retracements + Pivot Points')

plot(i_histPP and show_0     ? math.avg(htf_h1, htf_l1, htf_c1)                                   : na, 'PP'      , ta.change(time(htf)) ? na : color_0)
plot(i_histPP and show_0_236 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_0_236 : na, 'PP 0_236', ta.change(time(htf)) ? na : color_0_236, 1, plot.style_cross)
plot(i_histPP and show_0_236 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_0_236 : na, 'PP 0_236', ta.change(time(htf)) ? na : color_0_236, 1, plot.style_cross)
plot(i_histPP and show_0_382 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_0_382 : na, 'PP 0_382', ta.change(time(htf)) ? na : color_0_382)
plot(i_histPP and show_0_382 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_0_382 : na, 'PP 0_382', ta.change(time(htf)) ? na : color_0_382)
plot(i_histPP and show_0_5   ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_0_5   : na, 'PP 0_5  ', ta.change(time(htf)) ? na : color_0_5  , 1, plot.style_cross)
plot(i_histPP and show_0_5   ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_0_5   : na, 'PP 0_5  ', ta.change(time(htf)) ? na : color_0_5  , 1, plot.style_cross)
plot(i_histPP and show_0_618 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_0_618 : na, 'PP 0_618', ta.change(time(htf)) ? na : color_0_618)
plot(i_histPP and show_0_618 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_0_618 : na, 'PP 0_618', ta.change(time(htf)) ? na : color_0_618)
plot(i_histPP and show_0_65  ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_0_65  : na, 'PP 0_65 ', ta.change(time(htf)) ? na : color_0_65 , 1, plot.style_cross)
plot(i_histPP and show_0_65  ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_0_65  : na, 'PP 0_65 ', ta.change(time(htf)) ? na : color_0_65 , 1, plot.style_cross)
plot(i_histPP and show_0_786 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_0_786 : na, 'PP 0_786', ta.change(time(htf)) ? na : color_0_786, 1, plot.style_cross)
plot(i_histPP and show_0_786 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_0_786 : na, 'PP 0_786', ta.change(time(htf)) ? na : color_0_786, 1, plot.style_cross)
plot(i_histPP and show_1     ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_1     : na, 'PP 1    ', ta.change(time(htf)) ? na : color_1)
plot(i_histPP and show_1     ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_1     : na, 'PP 1    ', ta.change(time(htf)) ? na : color_1)
plot(i_histPP and show_1_272 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_1_272 : na, 'PP 1_272', ta.change(time(htf)) ? na : color_1_272, 1, plot.style_cross)
plot(i_histPP and show_1_272 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_1_272 : na, 'PP 1_272', ta.change(time(htf)) ? na : color_1_272, 1, plot.style_cross)
plot(i_histPP and show_1_414 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_1_414 : na, 'PP 1_414', ta.change(time(htf)) ? na : color_1_414, 1, plot.style_cross)
plot(i_histPP and show_1_414 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_1_414 : na, 'PP 1_414', ta.change(time(htf)) ? na : color_1_414, 1, plot.style_cross)
plot(i_histPP and show_1_618 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_1_618 : na, 'PP 1_618', ta.change(time(htf)) ? na : color_1_618, 1, plot.style_cross)
plot(i_histPP and show_1_618 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_1_618 : na, 'PP 1_618', ta.change(time(htf)) ? na : color_1_618, 1, plot.style_cross)
plot(i_histPP and show_1_65  ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_1_65  : na, 'PP 1_65 ', ta.change(time(htf)) ? na : color_1_65 , 1, plot.style_cross)
plot(i_histPP and show_1_65  ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_1_65  : na, 'PP 1_65 ', ta.change(time(htf)) ? na : color_1_65 , 1, plot.style_cross)
plot(i_histPP and show_2_618 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_2_618 : na, 'PP 2_618', ta.change(time(htf)) ? na : color_2_618, 1, plot.style_cross)
plot(i_histPP and show_2_618 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_2_618 : na, 'PP 2_618', ta.change(time(htf)) ? na : color_2_618, 1, plot.style_cross)
plot(i_histPP and show_2_65  ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_2_65  : na, 'PP 2_65 ', ta.change(time(htf)) ? na : color_2_65 , 1, plot.style_cross)
plot(i_histPP and show_2_65  ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_2_65  : na, 'PP 2_65 ', ta.change(time(htf)) ? na : color_2_65 , 1, plot.style_cross)
plot(i_histPP and show_3_618 ? math.avg(htf_h1, htf_l1, htf_c1) - (htf_h1 - htf_l1) * value_3_618 : na, 'PP 3_618', ta.change(time(htf)) ? na : color_3_618, 1, plot.style_cross)
plot(i_histPP and show_3_618 ? math.avg(htf_h1, htf_l1, htf_c1) + (htf_h1 - htf_l1) * value_3_618 : na, 'PP 3_618', ta.change(time(htf)) ? na : color_3_618, 1, plot.style_cross)

// Fibonacci Retracement / Extention / Pivot Points and Zig Zag
// ══════════════════════════════════════════════════════════════════════════════════════════════════ //

// ══════════════════════════════════════════════════════════════════════════════════════════════════ //
//
// Volume / Volatility AddOns
// ══════════════════════════════════════════════════════════════════════════════════════════════════ //

// ---------------------------------------------------------------------------------------------- //
// -Inputs -------------------------------------------------------------------------------------- //

group_vol_vol = 'Volume / Volatility AddOns'
tooltip_volume_spike_sign_of_exhaustion = 'Moments where\n' + 'huge volume detected : current volume is grater than the product of the theshold value and volume moving average'

tooltip_high_volatility = 'Moments where\n' + 'price range of the current bar is grater than the product of the theshold value and average true range value of defined period'

tooltip_volume_weighted_colored_bars = 'Volume Weighted Colored Bars\nColors bars based on the bar\'s volume relative to volume moving average'

// ---------------------------------------------------------------------------------------------- //
// High Volatility ------------------------------------------------------------------------------ //

i_hATRLb = input.bool(true, '⚡', inline='ATR', group=group_vol_vol, tooltip=tooltip_high_volatility)
i_weightedATR = ta.atr(input.int(13, 'ATR : Length', inline='ATR', group=group_vol_vol)) * input.float(2.718, 'Mult', minval=.1, step=.1, inline='ATR', group=group_vol_vol)

// ---------------------------------------------------------------------------------------------- //
// Volume Moving Average : Base ----------------------------------------------------------------- //

i_vSMA = ta.sma(nz(volume), input.int(89, 'Volume Moving Average Length', group=group_vol_vol))

// ---------------------------------------------------------------------------------------------- //
// Volume Spike - Sign of Exhaustion ------------------------------------------------------------ //

i_vSpikeLb = input.bool(true, '🚦', inline='SRS1', group=group_vol_vol, tooltip=tooltip_volume_spike_sign_of_exhaustion)
i_vSpikeThresh = input.float(4.669, 'Volume Spike Theshold           ', minval=.1, step=.1, inline='SRS1', group=group_vol_vol)

// ---------------------------------------------------------------------------------------------- //
// Volume Weighted Colored Bars ----------------------------------------------------------------- //

i_vwcb = input.bool(true, '', inline='VWC', group=group_vol_vol, tooltip=tooltip_volume_weighted_colored_bars)
i_vwcbHighThresh = input.float(1.618, 'VWCB :   High ', minval=1., step=.1, inline='VWC', group=group_vol_vol)
i_vwcbLowThresh = input.float(0.618, ' Low', minval=.1, step=.1, inline='VWC', group=group_vol_vol)


// ---------------------------------------------------------------------------------------------- //
// -Calculations and Plotting ------------------------------------------------------------------- //

nzVolume = nz(volume)
bullCandle = close > open
bearCandle = close < open
range_1 = math.abs(high - low)

// ---------------------------------------------------------------------------------------------- //
// Volume Spike - Sign of Exhaustion ------------------------------------------------------------ //

exhaustVol = nzVolume > i_vSpikeThresh * i_vSMA
plotchar(i_vSpikeLb and nzVolume ? exhaustVol : na, 'Exhaustion Bar', '🚦', location.abovebar, size=size.tiny)
alertcondition(ta.crossover(nzVolume, i_vSMA * i_vSpikeThresh), 'Volume Spikes', 'sign of exhaustion, huge volume increase detected\n{{exchange}}:{{ticker}}->\nOpen = {{open}}, Current = {{close}},\nTime = {{time}}')

// ---------------------------------------------------------------------------------------------- //
// High Volatility ------------------------------------------------------------------------------ //

highVolatility = range_1 > i_weightedATR
plotchar(i_hATRLb ? highVolatility : na, 'High Volatile Bar', '⚡', location.belowbar, size=size.tiny)
alertcondition(ta.crossover(range_1, i_weightedATR), 'High Volatility', 'high volatility detected\n{{exchange}}:{{ticker}}->\nOpen = {{open}}, Current = {{close}},\nTime = {{time}}')

// ---------------------------------------------------------------------------------------------- //
// Volume Weighted Colored Bars by Kıvanç Özbilgiç ---------------------------------------------- //

vwcbCol = nzVolume > i_vSMA * i_vwcbHighThresh ? bullCandle ? #006400 : #910000 : nzVolume < i_vSMA * i_vwcbLowThresh ? bearCandle ? #FF9800 : #7FFFD4 : na

barcolor(i_vwcb and nzVolume ? vwcbCol : na, title='Volume Weighted Colored Bars')

// Voloume / Volatility AddOns
// ══════════════════════════════════════════════════════════════════════════════════════════════════ //

var table logo = table.new(position.bottom_right, 1, 1)
table.cell(logo, 0, 0, '☼☾  ', text_size=size.normal, text_color=color.teal)

//---------endoffibo


var a_lines = array.new_line(i_size, na)
var a_vol = array.new_float(i_size, 0)
var a_box = array.new_box(i_size, na)
var tempArray = array.new_float(i_size, 0)
var tmpAmax = 0.
var index = 0
//var lpoc_now = na
var abox_index = 0
var line l_POC = na
line.delete(l_POC)

// if change new period  
if chT_H
    // before adding a new series of lines -> wrap up

    // Draw POC
    l_POC := line.new(line.get_x1(array.get(a_lines, index)), math.avg(line.get_y1(array.get(a_lines, index)), line.get_y1(array.get(a_lines, index + 1))), line.get_x2(array.get(a_lines, index)) + 100, math.avg(line.get_y1(array.get(a_lines, index)), line.get_y1(array.get(a_lines, index + 1))), color=c_POC)
   // place box just 1 bar further  
    if array.size(a_box) > 0
        box.set_right(array.get(a_box, 0), bar_index)  // move latest box (right size) 1 bar_index further when new period
    // create new box
    array.unshift(a_box, box.new(bar_index, high, bar_index, low, border_color=na, bgcolor=color.new(c_vol, 95)))
    // clean-up if max is reached
    if array.size(a_box) > math.ceil(aMax / i_size)
        box.delete(array.get(a_box, array.size(a_box) - 1))
        array.pop(a_box)
    // adding a new series of lines
    for i = 0 to i_size - 1 by 1
        // create x amount of memory space for volume (lines)
        array.unshift(a_lines, line.new(bar_index, high - (high - low) / i_size * i, bar_index, high - (high - low) / i_size * (i + 1), width=1, color=c_vol))  // create new x amount of lines (parts)
        array.unshift(a_vol, 0)
        // clean-up if max is reached
        if array.size(a_lines) > aMax
            line.delete(array.get(a_lines, array.size(a_lines) - 1))
            array.pop(a_lines)
            array.pop(a_vol)

if array.size(a_lines) > 0
    //if not chT_H 
    box.set_right(array.get(a_box, 0), bar_index)  // make existing box 1 bar larger to the right
    line.set_x2(l_POC, bar_index)  // make existing POC 1 bar larger to the right
    hi = line.get_y1(array.get(a_lines, 0))  // highest high of HTF 
    lo = line.get_y2(array.get(a_lines, i_size - 1))  // lowest low of HTF 

    if high > hi
        for i = 0 to i_size - 1 by 1
            line.set_y1(array.get(a_lines, 0), high)
            hi := line.get_y1(array.get(a_lines, 0))
            line.set_y1(array.get(a_lines, i), hi - (hi - lo) / i_size * i)
            line.set_y2(array.get(a_lines, i), hi - (hi - lo) / i_size * (i + 1))
            box.set_top(array.get(a_box, 0), hi)
    if low < lo
        for i = 0 to i_size - 1 by 1
            line.set_y2(array.get(a_lines, i_size - 1), low)
            lo := line.get_y2(array.get(a_lines, i_size - 1))
            line.set_y1(array.get(a_lines, i), hi - (hi - lo) / i_size * i)
            line.set_y2(array.get(a_lines, i), hi - (hi - lo) / i_size * (i + 1))
            box.set_bottom(array.get(a_box, 0), lo)

    for i = 0 to i_size - 1 by 1
        if high >= line.get_y1(array.get(a_lines, i)) and low <= line.get_y2(array.get(a_lines, i))
            array.set(a_vol, i, array.get(a_vol, i) + volume)
            line.set_width(array.get(a_lines, i), math.round(array.get(a_vol, i)))
//lpoc_now = 0.0
if array.size(a_vol) > 0
    for i = 0 to array.size(tempArray) - 1 by 1
        line.set_color(array.get(a_lines, i), c_vol)
        array.set(tempArray, i, array.get(a_vol, i))
    tmpAmax := array.max(tempArray)
    index := array.indexof(tempArray, tmpAmax)
    line.set_color(array.get(a_lines, index), c_volH)
    l_POC := line.new(line.get_x1(array.get(a_lines, index)), math.avg(line.get_y1(array.get(a_lines, index)), line.get_y1(array.get(a_lines, index + 1))), line.get_x2(array.get(a_lines, index)) + 100, math.avg(line.get_y1(array.get(a_lines, index)), line.get_y1(array.get(a_lines, index + 1))), color=c_POC)
lpoc_now = line.get_y1(l_POC)
    
if barstate.islast
    for i = 0 to array.size(a_lines) - 1 by 1
        boxL = box.get_left(array.get(a_box, 0))
        boxR = box.get_right(array.get(a_box, 0))
        width = boxR - boxL
        line.set_width(array.get(a_lines, i), math.round(i_width / maxVol * array.get(a_vol, i)))  // at the last bar, adjust all line width's (to get a uniform comparison between lines)
        line.set_x2(l_POC, bar_index + 9)
barcolor(color.new(color.white, 9))  // make candles transparent        
////=================================macd below==========
var cumVol = 0.
cumVol += nz(volume)
if barstate.islast and cumVol == 0
    runtime.error("No volume is provided by the data vendor.")
src = close
obv = ta.cum(math.sign(ta.change(src)) * volume)
fast_length = 480   
slow_length = 1440
signal_length = 360
fast_ma =  ta.ema(obv, fast_length)
slow_ma =  ta.ema(obv, slow_length)
macd = fast_ma - slow_ma
signal = ta.ema(macd, signal_length)
hist = macd - signal
hist_ma = ta.sma(hist,63)
histt = hist > hist_ma ? 1 : hist < hist_ma ? -1 : 0    
///================profile below====

//====alert below=====
alert_data_msg := 
          "{ \"passphrase\" : \"knxcrazywin\",\n"  
          +"\"symbol\" : \"" + syminfo.ticker + "\",\n"
          + "\"vp601Ddata\": { \n"  
          + "\"l_POC-now\": " + str.tostring(math.avg(htf_h1, htf_l1, htf_c1), format.mintick) + ",\n" 
          + "\"l_POC-pre\": " + str.tostring(math.avg(htf_h1, htf_l1, htf_c1), format.mintick) 
          + "\n},"
          + "\"MACD\": { \n"
          + "\"fastma\": " + str.tostring(fast_ma[1]) + ",\n" 
          + "\"slowma\": " + str.tostring(slow_ma[1]) + ",\n" 
          + "\"macd\": " + str.tostring(macd[1]) + ",\n" 
          + "\"signal\": " + str.tostring(signal[1]) + ",\n" 
          + "\"hist\": " + str.tostring(hist[1]) + ",\n" 
          + "\"histt\": " + str.tostring(hist_ma[1]) 
          +"\n},"

////
// Calculate profile
///

block_high = ta.highest(high, block_size)
block_low = ta.lowest(low, block_size)
float highest_row_value = 0

float row0_price = na
int row0_width = 0
float row0_value = 0.0
row0_is_peak = false
float row1_price = na
int row1_width = 0
float row1_value = 0.0
row1_is_peak = false
float row2_price = na
int row2_width = 0
float row2_value = 0.0
row2_is_peak = false
float row3_price = na
int row3_width = 0
float row3_value = 0.0
row3_is_peak = false
float row4_price = na
int row4_width = 0
float row4_value = 0.0
row4_is_peak = false
float row5_price = na
int row5_width = 0
float row5_value = 0.0
row5_is_peak = false
float row6_price = na
int row6_width = 0
float row6_value = 0.0
row6_is_peak = false
float row7_price = na
int row7_width = 0
float row7_value = 0.0
row7_is_peak = false
float row8_price = na
int row8_width = 0
float row8_value = 0.0
row8_is_peak = false
float row9_price = na
int row9_width = 0
float row9_value = 0.0
row9_is_peak = false
float row10_price = na
int row10_width = 0
float row10_value = 0.0
row10_is_peak = false
float row11_price = na
int row11_width = 0
float row11_value = 0.0
row11_is_peak = false
float row12_price = na
int row12_width = 0
float row12_value = 0.0
row12_is_peak = false
float row13_price = na
int row13_width = 0
float row13_value = 0.0
row13_is_peak = false
float row14_price = na
int row14_width = 0
float row14_value = 0.0
row14_is_peak = false
float row15_price = na
int row15_width = 0
float row15_value = 0.0
row15_is_peak = false
float row16_price = na
int row16_width = 0
float row16_value = 0.0
row16_is_peak = false
float row17_price = na
int row17_width = 0
float row17_value = 0.0
row17_is_peak = false
float row18_price = na
int row18_width = 0
float row18_value = 0.0
row18_is_peak = false
float row19_price = na
int row19_width = 0
float row19_value = 0.0
row19_is_peak = false
float row20_price = na
int row20_width = 0
float row20_value = 0.0
row20_is_peak = false
float row21_price = na
int row21_width = 0
float row21_value = 0.0
row21_is_peak = false
float row22_price = na
int row22_width = 0
float row22_value = 0.0
row22_is_peak = false
float row23_price = na
int row23_width = 0
float row23_value = 0.0
row23_is_peak = false
float row24_price = na
int row24_width = 0
float row24_value = 0.0
row24_is_peak = false
float row25_price = na
int row25_width = 0
float row25_value = 0.0
row25_is_peak = false
float row26_price = na
int row26_width = 0
float row26_value = 0.0
row26_is_peak = false
float row27_price = na
int row27_width = 0
float row27_value = 0.0
row27_is_peak = false
float row28_price = na
int row28_width = 0
float row28_value = 0.0
row28_is_peak = false
float row29_price = na
int row29_width = 0
float row29_value = 0.0
row29_is_peak = false
float row30_price = na
int row30_width = 0
float row30_value = 0.0
row30_is_peak = false
float row31_price = na
int row31_width = 0
float row31_value = 0.0
row31_is_peak = false
float row32_price = na
int row32_width = 0
float row32_value = 0.0
row32_is_peak = false
float row33_price = na
int row33_width = 0
float row33_value = 0.0
row33_is_peak = false
float row34_price = na
int row34_width = 0
float row34_value = 0.0
row34_is_peak = false
float row35_price = na
int row35_width = 0
float row35_value = 0.0
row35_is_peak = false
float row36_price = na
int row36_width = 0
float row36_value = 0.0
row36_is_peak = false
float row37_price = na
int row37_width = 0
float row37_value = 0.0
row37_is_peak = false
float row38_price = na
int row38_width = 0
float row38_value = 0.0
row38_is_peak = false
float row39_price = na
int row39_width = 0
float row39_value = 0.0
row39_is_peak = false

if barstate.islast

    block_height = block_high - block_low
    row_height = block_height / 40

    row0_low = block_low + row_height * 0
    row0_high = block_low + row_height * 1
    row1_low = block_low + row_height * 1
    row1_high = block_low + row_height * 2
    row2_low = block_low + row_height * 2
    row2_high = block_low + row_height * 3
    row3_low = block_low + row_height * 3
    row3_high = block_low + row_height * 4
    row4_low = block_low + row_height * 4
    row4_high = block_low + row_height * 5
    row5_low = block_low + row_height * 5
    row5_high = block_low + row_height * 6
    row6_low = block_low + row_height * 6
    row6_high = block_low + row_height * 7
    row7_low = block_low + row_height * 7
    row7_high = block_low + row_height * 8
    row8_low = block_low + row_height * 8
    row8_high = block_low + row_height * 9
    row9_low = block_low + row_height * 9
    row9_high = block_low + row_height * 10
    row10_low = block_low + row_height * 10
    row10_high = block_low + row_height * 11
    row11_low = block_low + row_height * 11
    row11_high = block_low + row_height * 12
    row12_low = block_low + row_height * 12
    row12_high = block_low + row_height * 13
    row13_low = block_low + row_height * 13
    row13_high = block_low + row_height * 14
    row14_low = block_low + row_height * 14
    row14_high = block_low + row_height * 15
    row15_low = block_low + row_height * 15
    row15_high = block_low + row_height * 16
    row16_low = block_low + row_height * 16
    row16_high = block_low + row_height * 17
    row17_low = block_low + row_height * 17
    row17_high = block_low + row_height * 18
    row18_low = block_low + row_height * 18
    row18_high = block_low + row_height * 19
    row19_low = block_low + row_height * 19
    row19_high = block_low + row_height * 20
    row20_low = block_low + row_height * 20
    row20_high = block_low + row_height * 21
    row21_low = block_low + row_height * 21
    row21_high = block_low + row_height * 22
    row22_low = block_low + row_height * 22
    row22_high = block_low + row_height * 23
    row23_low = block_low + row_height * 23
    row23_high = block_low + row_height * 24
    row24_low = block_low + row_height * 24
    row24_high = block_low + row_height * 25
    row25_low = block_low + row_height * 25
    row25_high = block_low + row_height * 26
    row26_low = block_low + row_height * 26
    row26_high = block_low + row_height * 27
    row27_low = block_low + row_height * 27
    row27_high = block_low + row_height * 28
    row28_low = block_low + row_height * 28
    row28_high = block_low + row_height * 29
    row29_low = block_low + row_height * 29
    row29_high = block_low + row_height * 30
    row30_low = block_low + row_height * 30
    row30_high = block_low + row_height * 31
    row31_low = block_low + row_height * 31
    row31_high = block_low + row_height * 32
    row32_low = block_low + row_height * 32
    row32_high = block_low + row_height * 33
    row33_low = block_low + row_height * 33
    row33_high = block_low + row_height * 34
    row34_low = block_low + row_height * 34
    row34_high = block_low + row_height * 35
    row35_low = block_low + row_height * 35
    row35_high = block_low + row_height * 36
    row36_low = block_low + row_height * 36
    row36_high = block_low + row_height * 37
    row37_low = block_low + row_height * 37
    row37_high = block_low + row_height * 38
    row38_low = block_low + row_height * 38
    row38_high = block_low + row_height * 39
    row39_low = block_low + row_height * 39
    row39_high = block_low + row_height * 40

    for i = 0 to block_size + 1 by 1
        n_rows_affected = 0
        bar_row0_value = 0.0
        if low[i] < row0_high and high[i] > row0_low
            bar_row0_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row1_value = 0.0
        if low[i] < row1_high and high[i] > row1_low
            bar_row1_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row2_value = 0.0
        if low[i] < row2_high and high[i] > row2_low
            bar_row2_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row3_value = 0.0
        if low[i] < row3_high and high[i] > row3_low
            bar_row3_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row4_value = 0.0
        if low[i] < row4_high and high[i] > row4_low
            bar_row4_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row5_value = 0.0
        if low[i] < row5_high and high[i] > row5_low
            bar_row5_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row6_value = 0.0
        if low[i] < row6_high and high[i] > row6_low
            bar_row6_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row7_value = 0.0
        if low[i] < row7_high and high[i] > row7_low
            bar_row7_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row8_value = 0.0
        if low[i] < row8_high and high[i] > row8_low
            bar_row8_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row9_value = 0.0
        if low[i] < row9_high and high[i] > row9_low
            bar_row9_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row10_value = 0.0
        if low[i] < row10_high and high[i] > row10_low
            bar_row10_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row11_value = 0.0
        if low[i] < row11_high and high[i] > row11_low
            bar_row11_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row12_value = 0.0
        if low[i] < row12_high and high[i] > row12_low
            bar_row12_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row13_value = 0.0
        if low[i] < row13_high and high[i] > row13_low
            bar_row13_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row14_value = 0.0
        if low[i] < row14_high and high[i] > row14_low
            bar_row14_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row15_value = 0.0
        if low[i] < row15_high and high[i] > row15_low
            bar_row15_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row16_value = 0.0
        if low[i] < row16_high and high[i] > row16_low
            bar_row16_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row17_value = 0.0
        if low[i] < row17_high and high[i] > row17_low
            bar_row17_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row18_value = 0.0
        if low[i] < row18_high and high[i] > row18_low
            bar_row18_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row19_value = 0.0
        if low[i] < row19_high and high[i] > row19_low
            bar_row19_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row20_value = 0.0
        if low[i] < row20_high and high[i] > row20_low
            bar_row20_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row21_value = 0.0
        if low[i] < row21_high and high[i] > row21_low
            bar_row21_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row22_value = 0.0
        if low[i] < row22_high and high[i] > row22_low
            bar_row22_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row23_value = 0.0
        if low[i] < row23_high and high[i] > row23_low
            bar_row23_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row24_value = 0.0
        if low[i] < row24_high and high[i] > row24_low
            bar_row24_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row25_value = 0.0
        if low[i] < row25_high and high[i] > row25_low
            bar_row25_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row26_value = 0.0
        if low[i] < row26_high and high[i] > row26_low
            bar_row26_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row27_value = 0.0
        if low[i] < row27_high and high[i] > row27_low
            bar_row27_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row28_value = 0.0
        if low[i] < row28_high and high[i] > row28_low
            bar_row28_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row29_value = 0.0
        if low[i] < row29_high and high[i] > row29_low
            bar_row29_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row30_value = 0.0
        if low[i] < row30_high and high[i] > row30_low
            bar_row30_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row31_value = 0.0
        if low[i] < row31_high and high[i] > row31_low
            bar_row31_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row32_value = 0.0
        if low[i] < row32_high and high[i] > row32_low
            bar_row32_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row33_value = 0.0
        if low[i] < row33_high and high[i] > row33_low
            bar_row33_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row34_value = 0.0
        if low[i] < row34_high and high[i] > row34_low
            bar_row34_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row35_value = 0.0
        if low[i] < row35_high and high[i] > row35_low
            bar_row35_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row36_value = 0.0
        if low[i] < row36_high and high[i] > row36_low
            bar_row36_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row37_value = 0.0
        if low[i] < row37_high and high[i] > row37_low
            bar_row37_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row38_value = 0.0
        if low[i] < row38_high and high[i] > row38_low
            bar_row38_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected
        bar_row39_value = 0.0
        if low[i] < row39_high and high[i] > row39_low
            bar_row39_value := nz(custom_volume[i])
            n_rows_affected += 1
            n_rows_affected

        row0_value += (n_rows_affected != 0 ? bar_row0_value / n_rows_affected : 0)
        row1_value += (n_rows_affected != 0 ? bar_row1_value / n_rows_affected : 0)
        row2_value += (n_rows_affected != 0 ? bar_row2_value / n_rows_affected : 0)
        row3_value += (n_rows_affected != 0 ? bar_row3_value / n_rows_affected : 0)
        row4_value += (n_rows_affected != 0 ? bar_row4_value / n_rows_affected : 0)
        row5_value += (n_rows_affected != 0 ? bar_row5_value / n_rows_affected : 0)
        row6_value += (n_rows_affected != 0 ? bar_row6_value / n_rows_affected : 0)
        row7_value += (n_rows_affected != 0 ? bar_row7_value / n_rows_affected : 0)
        row8_value += (n_rows_affected != 0 ? bar_row8_value / n_rows_affected : 0)
        row9_value += (n_rows_affected != 0 ? bar_row9_value / n_rows_affected : 0)
        row10_value += (n_rows_affected != 0 ? bar_row10_value / n_rows_affected : 0)
        row11_value += (n_rows_affected != 0 ? bar_row11_value / n_rows_affected : 0)
        row12_value += (n_rows_affected != 0 ? bar_row12_value / n_rows_affected : 0)
        row13_value += (n_rows_affected != 0 ? bar_row13_value / n_rows_affected : 0)
        row14_value += (n_rows_affected != 0 ? bar_row14_value / n_rows_affected : 0)
        row15_value += (n_rows_affected != 0 ? bar_row15_value / n_rows_affected : 0)
        row16_value += (n_rows_affected != 0 ? bar_row16_value / n_rows_affected : 0)
        row17_value += (n_rows_affected != 0 ? bar_row17_value / n_rows_affected : 0)
        row18_value += (n_rows_affected != 0 ? bar_row18_value / n_rows_affected : 0)
        row19_value += (n_rows_affected != 0 ? bar_row19_value / n_rows_affected : 0)
        row20_value += (n_rows_affected != 0 ? bar_row20_value / n_rows_affected : 0)
        row21_value += (n_rows_affected != 0 ? bar_row21_value / n_rows_affected : 0)
        row22_value += (n_rows_affected != 0 ? bar_row22_value / n_rows_affected : 0)
        row23_value += (n_rows_affected != 0 ? bar_row23_value / n_rows_affected : 0)
        row24_value += (n_rows_affected != 0 ? bar_row24_value / n_rows_affected : 0)
        row25_value += (n_rows_affected != 0 ? bar_row25_value / n_rows_affected : 0)
        row26_value += (n_rows_affected != 0 ? bar_row26_value / n_rows_affected : 0)
        row27_value += (n_rows_affected != 0 ? bar_row27_value / n_rows_affected : 0)
        row28_value += (n_rows_affected != 0 ? bar_row28_value / n_rows_affected : 0)
        row29_value += (n_rows_affected != 0 ? bar_row29_value / n_rows_affected : 0)
        row30_value += (n_rows_affected != 0 ? bar_row30_value / n_rows_affected : 0)
        row31_value += (n_rows_affected != 0 ? bar_row31_value / n_rows_affected : 0)
        row32_value += (n_rows_affected != 0 ? bar_row32_value / n_rows_affected : 0)
        row33_value += (n_rows_affected != 0 ? bar_row33_value / n_rows_affected : 0)
        row34_value += (n_rows_affected != 0 ? bar_row34_value / n_rows_affected : 0)
        row35_value += (n_rows_affected != 0 ? bar_row35_value / n_rows_affected : 0)
        row36_value += (n_rows_affected != 0 ? bar_row36_value / n_rows_affected : 0)
        row37_value += (n_rows_affected != 0 ? bar_row37_value / n_rows_affected : 0)
        row38_value += (n_rows_affected != 0 ? bar_row38_value / n_rows_affected : 0)
        row39_value += (n_rows_affected != 0 ? bar_row39_value / n_rows_affected : 0)
        row39_value

    highest_row_value := math.max(highest_row_value, row0_value)
    highest_row_value := math.max(highest_row_value, row1_value)
    highest_row_value := math.max(highest_row_value, row2_value)
    highest_row_value := math.max(highest_row_value, row3_value)
    highest_row_value := math.max(highest_row_value, row4_value)
    highest_row_value := math.max(highest_row_value, row5_value)
    highest_row_value := math.max(highest_row_value, row6_value)
    highest_row_value := math.max(highest_row_value, row7_value)
    highest_row_value := math.max(highest_row_value, row8_value)
    highest_row_value := math.max(highest_row_value, row9_value)
    highest_row_value := math.max(highest_row_value, row10_value)
    highest_row_value := math.max(highest_row_value, row11_value)
    highest_row_value := math.max(highest_row_value, row12_value)
    highest_row_value := math.max(highest_row_value, row13_value)
    highest_row_value := math.max(highest_row_value, row14_value)
    highest_row_value := math.max(highest_row_value, row15_value)
    highest_row_value := math.max(highest_row_value, row16_value)
    highest_row_value := math.max(highest_row_value, row17_value)
    highest_row_value := math.max(highest_row_value, row18_value)
    highest_row_value := math.max(highest_row_value, row19_value)
    highest_row_value := math.max(highest_row_value, row20_value)
    highest_row_value := math.max(highest_row_value, row21_value)
    highest_row_value := math.max(highest_row_value, row22_value)
    highest_row_value := math.max(highest_row_value, row23_value)
    highest_row_value := math.max(highest_row_value, row24_value)
    highest_row_value := math.max(highest_row_value, row25_value)
    highest_row_value := math.max(highest_row_value, row26_value)
    highest_row_value := math.max(highest_row_value, row27_value)
    highest_row_value := math.max(highest_row_value, row28_value)
    highest_row_value := math.max(highest_row_value, row29_value)
    highest_row_value := math.max(highest_row_value, row30_value)
    highest_row_value := math.max(highest_row_value, row31_value)
    highest_row_value := math.max(highest_row_value, row32_value)
    highest_row_value := math.max(highest_row_value, row33_value)
    highest_row_value := math.max(highest_row_value, row34_value)
    highest_row_value := math.max(highest_row_value, row35_value)
    highest_row_value := math.max(highest_row_value, row36_value)
    highest_row_value := math.max(highest_row_value, row37_value)
    highest_row_value := math.max(highest_row_value, row38_value)
    highest_row_value := math.max(highest_row_value, row39_value)

    row0_price := (row0_low + row0_high) / 2
    row0_width := math.floor(visual_row_width * row0_value / highest_row_value)
    row1_price := (row1_low + row1_high) / 2
    row1_width := math.floor(visual_row_width * row1_value / highest_row_value)
    row2_price := (row2_low + row2_high) / 2
    row2_width := math.floor(visual_row_width * row2_value / highest_row_value)
    row3_price := (row3_low + row3_high) / 2
    row3_width := math.floor(visual_row_width * row3_value / highest_row_value)
    row4_price := (row4_low + row4_high) / 2
    row4_width := math.floor(visual_row_width * row4_value / highest_row_value)
    row5_price := (row5_low + row5_high) / 2
    row5_width := math.floor(visual_row_width * row5_value / highest_row_value)
    row6_price := (row6_low + row6_high) / 2
    row6_width := math.floor(visual_row_width * row6_value / highest_row_value)
    row7_price := (row7_low + row7_high) / 2
    row7_width := math.floor(visual_row_width * row7_value / highest_row_value)
    row8_price := (row8_low + row8_high) / 2
    row8_width := math.floor(visual_row_width * row8_value / highest_row_value)
    row9_price := (row9_low + row9_high) / 2
    row9_width := math.floor(visual_row_width * row9_value / highest_row_value)
    row10_price := (row10_low + row10_high) / 2
    row10_width := math.floor(visual_row_width * row10_value / highest_row_value)
    row11_price := (row11_low + row11_high) / 2
    row11_width := math.floor(visual_row_width * row11_value / highest_row_value)
    row12_price := (row12_low + row12_high) / 2
    row12_width := math.floor(visual_row_width * row12_value / highest_row_value)
    row13_price := (row13_low + row13_high) / 2
    row13_width := math.floor(visual_row_width * row13_value / highest_row_value)
    row14_price := (row14_low + row14_high) / 2
    row14_width := math.floor(visual_row_width * row14_value / highest_row_value)
    row15_price := (row15_low + row15_high) / 2
    row15_width := math.floor(visual_row_width * row15_value / highest_row_value)
    row16_price := (row16_low + row16_high) / 2
    row16_width := math.floor(visual_row_width * row16_value / highest_row_value)
    row17_price := (row17_low + row17_high) / 2
    row17_width := math.floor(visual_row_width * row17_value / highest_row_value)
    row18_price := (row18_low + row18_high) / 2
    row18_width := math.floor(visual_row_width * row18_value / highest_row_value)
    row19_price := (row19_low + row19_high) / 2
    row19_width := math.floor(visual_row_width * row19_value / highest_row_value)
    row20_price := (row20_low + row20_high) / 2
    row20_width := math.floor(visual_row_width * row20_value / highest_row_value)
    row21_price := (row21_low + row21_high) / 2
    row21_width := math.floor(visual_row_width * row21_value / highest_row_value)
    row22_price := (row22_low + row22_high) / 2
    row22_width := math.floor(visual_row_width * row22_value / highest_row_value)
    row23_price := (row23_low + row23_high) / 2
    row23_width := math.floor(visual_row_width * row23_value / highest_row_value)
    row24_price := (row24_low + row24_high) / 2
    row24_width := math.floor(visual_row_width * row24_value / highest_row_value)
    row25_price := (row25_low + row25_high) / 2
    row25_width := math.floor(visual_row_width * row25_value / highest_row_value)
    row26_price := (row26_low + row26_high) / 2
    row26_width := math.floor(visual_row_width * row26_value / highest_row_value)
    row27_price := (row27_low + row27_high) / 2
    row27_width := math.floor(visual_row_width * row27_value / highest_row_value)
    row28_price := (row28_low + row28_high) / 2
    row28_width := math.floor(visual_row_width * row28_value / highest_row_value)
    row29_price := (row29_low + row29_high) / 2
    row29_width := math.floor(visual_row_width * row29_value / highest_row_value)
    row30_price := (row30_low + row30_high) / 2
    row30_width := math.floor(visual_row_width * row30_value / highest_row_value)
    row31_price := (row31_low + row31_high) / 2
    row31_width := math.floor(visual_row_width * row31_value / highest_row_value)
    row32_price := (row32_low + row32_high) / 2
    row32_width := math.floor(visual_row_width * row32_value / highest_row_value)
    row33_price := (row33_low + row33_high) / 2
    row33_width := math.floor(visual_row_width * row33_value / highest_row_value)
    row34_price := (row34_low + row34_high) / 2
    row34_width := math.floor(visual_row_width * row34_value / highest_row_value)
    row35_price := (row35_low + row35_high) / 2
    row35_width := math.floor(visual_row_width * row35_value / highest_row_value)
    row36_price := (row36_low + row36_high) / 2
    row36_width := math.floor(visual_row_width * row36_value / highest_row_value)
    row37_price := (row37_low + row37_high) / 2
    row37_width := math.floor(visual_row_width * row37_value / highest_row_value)
    row38_price := (row38_low + row38_high) / 2
    row38_width := math.floor(visual_row_width * row38_value / highest_row_value)
    row39_price := (row39_low + row39_high) / 2
    row39_width := math.floor(visual_row_width * row39_value / highest_row_value)

    if row0_value >= row1_value and row0_value >= row2_value and row0_value >= row3_value and row0_value >= row4_value and row0_value >= row5_value
        row0_is_peak := true
        row0_is_peak
    if row1_value >= row0_value and row1_value >= row2_value and row1_value >= row3_value and row1_value >= row4_value and row1_value >= row5_value and row1_value >= row6_value
        row1_is_peak := true
        row1_is_peak
    if row2_value >= row0_value and row2_value >= row1_value and row2_value >= row3_value and row2_value >= row4_value and row2_value >= row5_value and row2_value >= row6_value and row2_value >= row7_value
        row2_is_peak := true
        row2_is_peak
    if row3_value >= row0_value and row3_value >= row1_value and row3_value >= row2_value and row3_value >= row4_value and row3_value >= row5_value and row3_value >= row6_value and row3_value >= row7_value and row3_value >= row8_value
        row3_is_peak := true
        row3_is_peak
    if row4_value >= row0_value and row4_value >= row1_value and row4_value >= row2_value and row4_value >= row3_value and row4_value >= row5_value and row4_value >= row6_value and row4_value >= row7_value and row4_value >= row8_value and row4_value >= row9_value
        row4_is_peak := true
        row4_is_peak
    if row5_value >= row0_value and row5_value >= row1_value and row5_value >= row2_value and row5_value >= row3_value and row5_value >= row4_value and row5_value >= row6_value and row5_value >= row7_value and row5_value >= row8_value and row5_value >= row9_value and row5_value >= row10_value
        row5_is_peak := true
        row5_is_peak
    if row6_value >= row1_value and row6_value >= row2_value and row6_value >= row3_value and row6_value >= row4_value and row6_value >= row5_value and row6_value >= row7_value and row6_value >= row8_value and row6_value >= row9_value and row6_value >= row10_value and row6_value >= row11_value
        row6_is_peak := true
        row6_is_peak
    if row7_value >= row2_value and row7_value >= row3_value and row7_value >= row4_value and row7_value >= row5_value and row7_value >= row6_value and row7_value >= row8_value and row7_value >= row9_value and row7_value >= row10_value and row7_value >= row11_value and row7_value >= row12_value
        row7_is_peak := true
        row7_is_peak
    if row8_value >= row3_value and row8_value >= row4_value and row8_value >= row5_value and row8_value >= row6_value and row8_value >= row7_value and row8_value >= row9_value and row8_value >= row10_value and row8_value >= row11_value and row8_value >= row12_value and row8_value >= row13_value
        row8_is_peak := true
        row8_is_peak
    if row9_value >= row4_value and row9_value >= row5_value and row9_value >= row6_value and row9_value >= row7_value and row9_value >= row8_value and row9_value >= row10_value and row9_value >= row11_value and row9_value >= row12_value and row9_value >= row13_value and row9_value >= row14_value
        row9_is_peak := true
        row9_is_peak
    if row10_value >= row5_value and row10_value >= row6_value and row10_value >= row7_value and row10_value >= row8_value and row10_value >= row9_value and row10_value >= row11_value and row10_value >= row12_value and row10_value >= row13_value and row10_value >= row14_value and row10_value >= row15_value
        row10_is_peak := true
        row10_is_peak
    if row11_value >= row6_value and row11_value >= row7_value and row11_value >= row8_value and row11_value >= row9_value and row11_value >= row10_value and row11_value >= row12_value and row11_value >= row13_value and row11_value >= row14_value and row11_value >= row15_value and row11_value >= row16_value
        row11_is_peak := true
        row11_is_peak
    if row12_value >= row7_value and row12_value >= row8_value and row12_value >= row9_value and row12_value >= row10_value and row12_value >= row11_value and row12_value >= row13_value and row12_value >= row14_value and row12_value >= row15_value and row12_value >= row16_value and row12_value >= row17_value
        row12_is_peak := true
        row12_is_peak
    if row13_value >= row8_value and row13_value >= row9_value and row13_value >= row10_value and row13_value >= row11_value and row13_value >= row12_value and row13_value >= row14_value and row13_value >= row15_value and row13_value >= row16_value and row13_value >= row17_value and row13_value >= row18_value
        row13_is_peak := true
        row13_is_peak
    if row14_value >= row9_value and row14_value >= row10_value and row14_value >= row11_value and row14_value >= row12_value and row14_value >= row13_value and row14_value >= row15_value and row14_value >= row16_value and row14_value >= row17_value and row14_value >= row18_value and row14_value >= row19_value
        row14_is_peak := true
        row14_is_peak
    if row15_value >= row10_value and row15_value >= row11_value and row15_value >= row12_value and row15_value >= row13_value and row15_value >= row14_value and row15_value >= row16_value and row15_value >= row17_value and row15_value >= row18_value and row15_value >= row19_value and row15_value >= row20_value
        row15_is_peak := true
        row15_is_peak
    if row16_value >= row11_value and row16_value >= row12_value and row16_value >= row13_value and row16_value >= row14_value and row16_value >= row15_value and row16_value >= row17_value and row16_value >= row18_value and row16_value >= row19_value and row16_value >= row20_value and row16_value >= row21_value
        row16_is_peak := true
        row16_is_peak
    if row17_value >= row12_value and row17_value >= row13_value and row17_value >= row14_value and row17_value >= row15_value and row17_value >= row16_value and row17_value >= row18_value and row17_value >= row19_value and row17_value >= row20_value and row17_value >= row21_value and row17_value >= row22_value
        row17_is_peak := true
        row17_is_peak
    if row18_value >= row13_value and row18_value >= row14_value and row18_value >= row15_value and row18_value >= row16_value and row18_value >= row17_value and row18_value >= row19_value and row18_value >= row20_value and row18_value >= row21_value and row18_value >= row22_value and row18_value >= row23_value
        row18_is_peak := true
        row18_is_peak
    if row19_value >= row14_value and row19_value >= row15_value and row19_value >= row16_value and row19_value >= row17_value and row19_value >= row18_value and row19_value >= row20_value and row19_value >= row21_value and row19_value >= row22_value and row19_value >= row23_value and row19_value >= row24_value
        row19_is_peak := true
        row19_is_peak
    if row20_value >= row15_value and row20_value >= row16_value and row20_value >= row17_value and row20_value >= row18_value and row20_value >= row19_value and row20_value >= row21_value and row20_value >= row22_value and row20_value >= row23_value and row20_value >= row24_value and row20_value >= row25_value
        row20_is_peak := true
        row20_is_peak
    if row21_value >= row16_value and row21_value >= row17_value and row21_value >= row18_value and row21_value >= row19_value and row21_value >= row20_value and row21_value >= row22_value and row21_value >= row23_value and row21_value >= row24_value and row21_value >= row25_value and row21_value >= row26_value
        row21_is_peak := true
        row21_is_peak
    if row22_value >= row17_value and row22_value >= row18_value and row22_value >= row19_value and row22_value >= row20_value and row22_value >= row21_value and row22_value >= row23_value and row22_value >= row24_value and row22_value >= row25_value and row22_value >= row26_value and row22_value >= row27_value
        row22_is_peak := true
        row22_is_peak
    if row23_value >= row18_value and row23_value >= row19_value and row23_value >= row20_value and row23_value >= row21_value and row23_value >= row22_value and row23_value >= row24_value and row23_value >= row25_value and row23_value >= row26_value and row23_value >= row27_value and row23_value >= row28_value
        row23_is_peak := true
        row23_is_peak
    if row24_value >= row19_value and row24_value >= row20_value and row24_value >= row21_value and row24_value >= row22_value and row24_value >= row23_value and row24_value >= row25_value and row24_value >= row26_value and row24_value >= row27_value and row24_value >= row28_value and row24_value >= row29_value
        row24_is_peak := true
        row24_is_peak
    if row25_value >= row20_value and row25_value >= row21_value and row25_value >= row22_value and row25_value >= row23_value and row25_value >= row24_value and row25_value >= row26_value and row25_value >= row27_value and row25_value >= row28_value and row25_value >= row29_value and row25_value >= row30_value
        row25_is_peak := true
        row25_is_peak
    if row26_value >= row21_value and row26_value >= row22_value and row26_value >= row23_value and row26_value >= row24_value and row26_value >= row25_value and row26_value >= row27_value and row26_value >= row28_value and row26_value >= row29_value and row26_value >= row30_value and row26_value >= row31_value
        row26_is_peak := true
        row26_is_peak
    if row27_value >= row22_value and row27_value >= row23_value and row27_value >= row24_value and row27_value >= row25_value and row27_value >= row26_value and row27_value >= row28_value and row27_value >= row29_value and row27_value >= row30_value and row27_value >= row31_value and row27_value >= row32_value
        row27_is_peak := true
        row27_is_peak
    if row28_value >= row23_value and row28_value >= row24_value and row28_value >= row25_value and row28_value >= row26_value and row28_value >= row27_value and row28_value >= row29_value and row28_value >= row30_value and row28_value >= row31_value and row28_value >= row32_value and row28_value >= row33_value
        row28_is_peak := true
        row28_is_peak
    if row29_value >= row24_value and row29_value >= row25_value and row29_value >= row26_value and row29_value >= row27_value and row29_value >= row28_value and row29_value >= row30_value and row29_value >= row31_value and row29_value >= row32_value and row29_value >= row33_value and row29_value >= row34_value
        row29_is_peak := true
        row29_is_peak
    if row30_value >= row25_value and row30_value >= row26_value and row30_value >= row27_value and row30_value >= row28_value and row30_value >= row29_value and row30_value >= row31_value and row30_value >= row32_value and row30_value >= row33_value and row30_value >= row34_value and row30_value >= row35_value
        row30_is_peak := true
        row30_is_peak
    if row31_value >= row26_value and row31_value >= row27_value and row31_value >= row28_value and row31_value >= row29_value and row31_value >= row30_value and row31_value >= row32_value and row31_value >= row33_value and row31_value >= row34_value and row31_value >= row35_value and row31_value >= row36_value
        row31_is_peak := true
        row31_is_peak
    if row32_value >= row27_value and row32_value >= row28_value and row32_value >= row29_value and row32_value >= row30_value and row32_value >= row31_value and row32_value >= row33_value and row32_value >= row34_value and row32_value >= row35_value and row32_value >= row36_value and row32_value >= row37_value
        row32_is_peak := true
        row32_is_peak
    if row33_value >= row28_value and row33_value >= row29_value and row33_value >= row30_value and row33_value >= row31_value and row33_value >= row32_value and row33_value >= row34_value and row33_value >= row35_value and row33_value >= row36_value and row33_value >= row37_value and row33_value >= row38_value
        row33_is_peak := true
        row33_is_peak
    if row34_value >= row29_value and row34_value >= row30_value and row34_value >= row31_value and row34_value >= row32_value and row34_value >= row33_value and row34_value >= row35_value and row34_value >= row36_value and row34_value >= row37_value and row34_value >= row38_value and row34_value >= row39_value
        row34_is_peak := true
        row34_is_peak
    if row35_value >= row30_value and row35_value >= row31_value and row35_value >= row32_value and row35_value >= row33_value and row35_value >= row34_value and row35_value >= row36_value and row35_value >= row37_value and row35_value >= row38_value and row35_value >= row39_value
        row35_is_peak := true
        row35_is_peak
    if row36_value >= row31_value and row36_value >= row32_value and row36_value >= row33_value and row36_value >= row34_value and row36_value >= row35_value and row36_value >= row37_value and row36_value >= row38_value and row36_value >= row39_value
        row36_is_peak := true
        row36_is_peak
    if row37_value >= row32_value and row37_value >= row33_value and row37_value >= row34_value and row37_value >= row35_value and row37_value >= row36_value and row37_value >= row38_value and row37_value >= row39_value
        row37_is_peak := true
        row37_is_peak
    if row38_value >= row33_value and row38_value >= row34_value and row38_value >= row35_value and row38_value >= row36_value and row38_value >= row37_value and row38_value >= row39_value
        row38_is_peak := true
        row38_is_peak
    if row39_value >= row34_value and row39_value >= row35_value and row39_value >= row36_value and row39_value >= row37_value and row39_value >= row38_value
        row39_is_peak := true
        row39_is_peak

////
// Draw profile
///

var int first_bar_time = time
if barstate.isfirst
    first_bar_time := time
    first_bar_time

var line block_high_line = line.new(bar_index, high, bar_index, high, color=BOUNDS_COLOR)
var line block_low_line = line.new(bar_index, low, bar_index, low, color=BOUNDS_COLOR)
var label row0_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row1_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row2_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row3_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row4_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row5_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row6_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row7_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row8_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row9_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row10_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row11_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row12_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row13_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row14_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row15_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row16_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row17_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row18_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row19_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row20_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row21_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row22_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row23_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row24_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row25_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row26_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row27_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row28_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row29_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row30_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row31_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row32_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row33_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row34_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row35_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row36_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row37_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row38_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)
var label row39_label = label.new(time_close, close, '', xloc=xloc.bar_time, yloc=yloc.price, color=PROFILE_COLOR, style=label.style_label_left, size=size.auto)

if barstate.islast
    line.set_xloc(block_high_line, math.max(time[block_size], first_bar_time), time_close, xloc.bar_time)
    line.set_y1(block_high_line, block_high)
    line.set_y2(block_high_line, block_high)
	alert_data_msg += "\"Profile\": { \n"
      + "\"VPHigh\": " + str.tostring(block_high) + ",\n"
	//alert_data_msg = alert_data_msg + alert_h 
    line.set_xloc(block_low_line, math.max(time[block_size], first_bar_time), time_close, xloc.bar_time)
    line.set_y1(block_low_line, block_low)
    line.set_y2(block_low_line, block_low)
	alert_real := 		   
          "\"VPLow\": " + str.tostring(block_low) 
          + "\n}}"

    row0_text = ''
    for i = 0 to row0_width + 1 by 1
        row0_text += '#'
        row0_text
    row0_color = show_peaks and row0_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row0_label, time_close)
    label.set_y(row0_label, row0_price)
    label.set_color(row0_label, row0_color)
    label.set_textcolor(row0_label, row0_color)
    label.set_text(row0_label, row0_text)
	if row0_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row0_price) + ",\n"

    row1_text = ''
    for i = 0 to row1_width + 1 by 1
        row1_text += '#'
        row1_text
    row1_color = show_peaks and row1_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row1_label, time_close)
    label.set_y(row1_label, row1_price)
    label.set_color(row1_label, row1_color)
    label.set_textcolor(row1_label, row1_color)
    label.set_text(row1_label, row1_text)
	if row1_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row1_price) + ",\n"

    row2_text = ''
    for i = 0 to row2_width + 1 by 1
        row2_text += '#'
        row2_text
    row2_color = show_peaks and row2_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row2_label, time_close)
    label.set_y(row2_label, row2_price)
    label.set_color(row2_label, row2_color)
    label.set_textcolor(row2_label, row2_color)
    label.set_text(row2_label, row2_text)
    if row2_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row2_price) + ",\n"

	row3_text = ''
    for i = 0 to row3_width + 1 by 1
        row3_text += '#'
        row3_text
    row3_color = show_peaks and row3_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row3_label, time_close)
    label.set_y(row3_label, row3_price)
    label.set_color(row3_label, row3_color)
    label.set_textcolor(row3_label, row3_color)
    label.set_text(row3_label, row3_text)
	if row3_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row3_price) + ",\n"

    row4_text = ''
    for i = 0 to row4_width + 1 by 1
        row4_text += '#'
        row4_text
    row4_color = show_peaks and row4_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row4_label, time_close)
    label.set_y(row4_label, row4_price)
    label.set_color(row4_label, row4_color)
    label.set_textcolor(row4_label, row4_color)
    label.set_text(row4_label, row4_text)
	if row4_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row4_price) + ",\n"

    row5_text = ''
    for i = 0 to row5_width + 1 by 1
        row5_text += '#'
        row5_text
    row5_color = show_peaks and row5_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row5_label, time_close)
    label.set_y(row5_label, row5_price)
    label.set_color(row5_label, row5_color)
    label.set_textcolor(row5_label, row5_color)
    label.set_text(row5_label, row5_text)
	if row5_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row5_price) + ",\n"

    row6_text = ''
    for i = 0 to row6_width + 1 by 1
        row6_text += '#'
        row6_text
    row6_color = show_peaks and row6_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row6_label, time_close)
    label.set_y(row6_label, row6_price)
    label.set_color(row6_label, row6_color)
    label.set_textcolor(row6_label, row6_color)
    label.set_text(row6_label, row6_text)
	if row6_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row6_price) + ",\n"

    row7_text = ''
    for i = 0 to row7_width + 1 by 1
        row7_text += '#'
        row7_text
    row7_color = show_peaks and row7_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row7_label, time_close)
    label.set_y(row7_label, row7_price)
    label.set_color(row7_label, row7_color)
    label.set_textcolor(row7_label, row7_color)
    label.set_text(row7_label, row7_text)
	if row7_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row7_price) + ",\n"

    row8_text = ''
    for i = 0 to row8_width + 1 by 1
        row8_text += '#'
        row8_text
    row8_color = show_peaks and row8_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row8_label, time_close)
    label.set_y(row8_label, row8_price)
    label.set_color(row8_label, row8_color)
    label.set_textcolor(row8_label, row8_color)
    label.set_text(row8_label, row8_text)
	if row8_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row8_price) + ",\n"

    row9_text = ''
    for i = 0 to row9_width + 1 by 1
        row9_text += '#'
        row9_text
    row9_color = show_peaks and row9_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row9_label, time_close)
    label.set_y(row9_label, row9_price)
    label.set_color(row9_label, row9_color)
    label.set_textcolor(row9_label, row9_color)
    label.set_text(row9_label, row9_text)
	if row9_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row9_price) + ",\n"

    row10_text = ''
    for i = 0 to row10_width + 1 by 1
        row10_text += '#'
        row10_text
    row10_color = show_peaks and row10_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row10_label, time_close)
    label.set_y(row10_label, row10_price)
    label.set_color(row10_label, row10_color)
    label.set_textcolor(row10_label, row10_color)
    label.set_text(row10_label, row10_text)
	if row10_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row10_price) + ",\n"

    row11_text = ''
    for i = 0 to row11_width + 1 by 1
        row11_text += '#'
        row11_text
    row11_color = show_peaks and row11_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row11_label, time_close)
    label.set_y(row11_label, row11_price)
    label.set_color(row11_label, row11_color)
    label.set_textcolor(row11_label, row11_color)
    label.set_text(row11_label, row11_text)
	if row11_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row11_price) + ",\n"

    row12_text = ''
    for i = 0 to row12_width + 1 by 1
        row12_text += '#'
        row12_text
    row12_color = show_peaks and row12_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row12_label, time_close)
    label.set_y(row12_label, row12_price)
    label.set_color(row12_label, row12_color)
    label.set_textcolor(row12_label, row12_color)
    label.set_text(row12_label, row12_text)
	if row12_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row12_price) + ",\n"

    row13_text = ''
    for i = 0 to row13_width + 1 by 1
        row13_text += '#'
        row13_text
    row13_color = show_peaks and row13_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row13_label, time_close)
    label.set_y(row13_label, row13_price)
    label.set_color(row13_label, row13_color)
    label.set_textcolor(row13_label, row13_color)
    label.set_text(row13_label, row13_text)
	if row13_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row13_price) + ",\n"

    row14_text = ''
    for i = 0 to row14_width + 1 by 1
        row14_text += '#'
        row14_text
    row14_color = show_peaks and row14_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row14_label, time_close)
    label.set_y(row14_label, row14_price)
    label.set_color(row14_label, row14_color)
    label.set_textcolor(row14_label, row14_color)
    label.set_text(row14_label, row14_text)
	if row14_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row14_price) + ",\n"

    row15_text = ''
    for i = 0 to row15_width + 1 by 1
        row15_text += '#'
        row15_text
    row15_color = show_peaks and row15_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row15_label, time_close)
    label.set_y(row15_label, row15_price)
    label.set_color(row15_label, row15_color)
    label.set_textcolor(row15_label, row15_color)
    label.set_text(row15_label, row15_text)
	if row15_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row15_price) + ",\n"

    row16_text = ''
    for i = 0 to row16_width + 1 by 1
        row16_text += '#'
        row16_text
    row16_color = show_peaks and row16_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row16_label, time_close)
    label.set_y(row16_label, row16_price)
    label.set_color(row16_label, row16_color)
    label.set_textcolor(row16_label, row16_color)
    label.set_text(row16_label, row16_text)
	if row16_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row16_price) + ",\n"

    row17_text = ''
    for i = 0 to row17_width + 1 by 1
        row17_text += '#'
        row17_text
    row17_color = show_peaks and row17_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row17_label, time_close)
    label.set_y(row17_label, row17_price)
    label.set_color(row17_label, row17_color)
    label.set_textcolor(row17_label, row17_color)
    label.set_text(row17_label, row17_text)
	if row17_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row17_price) + ",\n"

    row18_text = ''
    for i = 0 to row18_width + 1 by 1
        row18_text += '#'
        row18_text
    row18_color = show_peaks and row18_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row18_label, time_close)
    label.set_y(row18_label, row18_price)
    label.set_color(row18_label, row18_color)
    label.set_textcolor(row18_label, row18_color)
    label.set_text(row18_label, row18_text)
	if row18_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row18_price) + ",\n"

    row19_text = ''
    for i = 0 to row19_width + 1 by 1
        row19_text += '#'
        row19_text
    row19_color = show_peaks and row19_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row19_label, time_close)
    label.set_y(row19_label, row19_price)
    label.set_color(row19_label, row19_color)
    label.set_textcolor(row19_label, row19_color)
    label.set_text(row19_label, row19_text)
	if row19_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row19_price) + ",\n"

    row20_text = ''
    for i = 0 to row20_width + 1 by 1
        row20_text += '#'
        row20_text
    row20_color = show_peaks and row20_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row20_label, time_close)
    label.set_y(row20_label, row20_price)
    label.set_color(row20_label, row20_color)
    label.set_textcolor(row20_label, row20_color)
    label.set_text(row20_label, row20_text)
	alert_data_msg += "\"VP_Mid\": " + str.tostring((row19_price+row20_price)/2) + ",\n"
	if row20_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row20_price) + ",\n"

    row21_text = ''
    for i = 0 to row21_width + 1 by 1
        row21_text += '#'
        row21_text
    row21_color = show_peaks and row21_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row21_label, time_close)
    label.set_y(row21_label, row21_price)
    label.set_color(row21_label, row21_color)
    label.set_textcolor(row21_label, row21_color)
    label.set_text(row21_label, row21_text)
	if row21_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row21_price) + ",\n"

    row22_text = ''
    for i = 0 to row22_width + 1 by 1
        row22_text += '#'
        row22_text
    row22_color = show_peaks and row22_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row22_label, time_close)
    label.set_y(row22_label, row22_price)
    label.set_color(row22_label, row22_color)
    label.set_textcolor(row22_label, row22_color)
    label.set_text(row22_label, row22_text)
	if row22_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row22_price) + ",\n"

    row23_text = ''
    for i = 0 to row23_width + 1 by 1
        row23_text += '#'
        row23_text
    row23_color = show_peaks and row23_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row23_label, time_close)
    label.set_y(row23_label, row23_price)
    label.set_color(row23_label, row23_color)
    label.set_textcolor(row23_label, row23_color)
    label.set_text(row23_label, row23_text)
	if row23_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row23_price) + ",\n"

    row24_text = ''
    for i = 0 to row24_width + 1 by 1
        row24_text += '#'
        row24_text
    row24_color = show_peaks and row24_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row24_label, time_close)
    label.set_y(row24_label, row24_price)
    label.set_color(row24_label, row24_color)
    label.set_textcolor(row24_label, row24_color)
    label.set_text(row24_label, row24_text)
	if row24_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row24_price) + ",\n"

    row25_text = ''
    for i = 0 to row25_width + 1 by 1
        row25_text += '#'
        row25_text
    row25_color = show_peaks and row25_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row25_label, time_close)
    label.set_y(row25_label, row25_price)
    label.set_color(row25_label, row25_color)
    label.set_textcolor(row25_label, row25_color)
    label.set_text(row25_label, row25_text)
	if row25_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row25_price) + ",\n"

    row26_text = ''
    for i = 0 to row26_width + 1 by 1
        row26_text += '#'
        row26_text
    row26_color = show_peaks and row26_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row26_label, time_close)
    label.set_y(row26_label, row26_price)
    label.set_color(row26_label, row26_color)
    label.set_textcolor(row26_label, row26_color)
    label.set_text(row26_label, row26_text)
	if row26_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row26_price) + ",\n"

    row27_text = ''
    for i = 0 to row27_width + 1 by 1
        row27_text += '#'
        row27_text
    row27_color = show_peaks and row27_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row27_label, time_close)
    label.set_y(row27_label, row27_price)
    label.set_color(row27_label, row27_color)
    label.set_textcolor(row27_label, row27_color)
    label.set_text(row27_label, row27_text)
	if row27_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row27_price) + ",\n"

    row28_text = ''
    for i = 0 to row28_width + 1 by 1
        row28_text += '#'
        row28_text
    row28_color = show_peaks and row28_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row28_label, time_close)
    label.set_y(row28_label, row28_price)
    label.set_color(row28_label, row28_color)
    label.set_textcolor(row28_label, row28_color)
    label.set_text(row28_label, row28_text)
	if row28_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row28_price) + ",\n"

    row29_text = ''
    for i = 0 to row29_width + 1 by 1
        row29_text += '#'
        row29_text
    row29_color = show_peaks and row29_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row29_label, time_close)
    label.set_y(row29_label, row29_price)
    label.set_color(row29_label, row29_color)
    label.set_textcolor(row29_label, row29_color)
    label.set_text(row29_label, row29_text)
	if row29_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row29_price) + ",\n"

    row30_text = ''
    for i = 0 to row30_width + 1 by 1
        row30_text += '#'
        row30_text
    row30_color = show_peaks and row30_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row30_label, time_close)
    label.set_y(row30_label, row30_price)
    label.set_color(row30_label, row30_color)
    label.set_textcolor(row30_label, row30_color)
    label.set_text(row30_label, row30_text)
	if row30_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row30_price) + ",\n"

    row31_text = ''
    for i = 0 to row31_width + 1 by 1
        row31_text += '#'
        row31_text
    row31_color = show_peaks and row31_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row31_label, time_close)
    label.set_y(row31_label, row31_price)
    label.set_color(row31_label, row31_color)
    label.set_textcolor(row31_label, row31_color)
    label.set_text(row31_label, row31_text)
	if row31_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row31_price) + ",\n"

    row32_text = ''
    for i = 0 to row32_width + 1 by 1
        row32_text += '#'
        row32_text
    row32_color = show_peaks and row32_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row32_label, time_close)
    label.set_y(row32_label, row32_price)
    label.set_color(row32_label, row32_color)
    label.set_textcolor(row32_label, row32_color)
    label.set_text(row32_label, row32_text)
	if row32_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row32_price) + ",\n"

    row33_text = ''
    for i = 0 to row33_width + 1 by 1
        row33_text += '#'
        row33_text
    row33_color = show_peaks and row33_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row33_label, time_close)
    label.set_y(row33_label, row33_price)
    label.set_color(row33_label, row33_color)
    label.set_textcolor(row33_label, row33_color)
    label.set_text(row33_label, row33_text)
	if row33_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row33_price) + ",\n"

    row34_text = ''
    for i = 0 to row34_width + 1 by 1
        row34_text += '#'
        row34_text
    row34_color = show_peaks and row34_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row34_label, time_close)
    label.set_y(row34_label, row34_price)
    label.set_color(row34_label, row34_color)
    label.set_textcolor(row34_label, row34_color)
    label.set_text(row34_label, row34_text)
	if row34_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row34_price) + ",\n"

    row35_text = ''
    for i = 0 to row35_width + 1 by 1
        row35_text += '#'
        row35_text
    row35_color = show_peaks and row35_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row35_label, time_close)
    label.set_y(row35_label, row35_price)
    label.set_color(row35_label, row35_color)
    label.set_textcolor(row35_label, row35_color)
    label.set_text(row35_label, row35_text)
	if row35_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row35_price) + ",\n"

    row36_text = ''
    for i = 0 to row36_width + 1 by 1
        row36_text += '#'
        row36_text
    row36_color = show_peaks and row36_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row36_label, time_close)
    label.set_y(row36_label, row36_price)
    label.set_color(row36_label, row36_color)
    label.set_textcolor(row36_label, row36_color)
    label.set_text(row36_label, row36_text)
	if row36_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row36_price) + ",\n"

    row37_text = ''
    for i = 0 to row37_width + 1 by 1
        row37_text += '#'
        row37_text
    row37_color = show_peaks and row37_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row37_label, time_close)
    label.set_y(row37_label, row37_price)
    label.set_color(row37_label, row37_color)
    label.set_textcolor(row37_label, row37_color)
    label.set_text(row37_label, row37_text)
	if row37_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row37_price) + ",\n"

    row38_text = ''
    for i = 0 to row38_width + 1 by 1
        row38_text += '#'
        row38_text
    row38_color = show_peaks and row38_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row38_label, time_close)
    label.set_y(row38_label, row38_price)
    label.set_color(row38_label, row38_color)
    label.set_textcolor(row38_label, row38_color)
    label.set_text(row38_label, row38_text)
	if row38_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row38_price) + ",\n"

    row39_text = ''
    for i = 0 to row39_width + 1 by 1
        row39_text += '#'
        row39_text
    row39_color = show_peaks and row39_is_peak ? PEAK_COLOR : PROFILE_COLOR
    label.set_x(row39_label, time_close)
    label.set_y(row39_label, row39_price)
    label.set_color(row39_label, row39_color)
    label.set_textcolor(row39_label, row39_color)
    label.set_text(row39_label, row39_text)
	if row39_is_peak
		alert_data_msg +=  "\"VP_Peak\": " + str.tostring(row39_price) + ",\n"

alert_data_msg := alert_data_msg + alert_real
alert(message = alert_data_msg, freq = alert.freq_once_per_bar)




